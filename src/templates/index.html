<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMEET - AI Collective Intelligence Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .screen { display: none; }
        .screen.active { display: block; }
        .screen-card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 48rem; /* 768px */
            margin: 2rem;
            overflow: hidden;
        }
        .screen-header {
            background-color: #f8fafc;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 700;
            color: #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .screen-body { padding: 2rem; }
        .text-primary { color: #2563eb; }
        .btn { border-radius: 0.75rem; font-weight: 700; padding: 0.75rem 1.5rem; transition: all 0.2s ease; cursor: pointer; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .btn-primary:disabled { background-color: #93c5fd; cursor: not-allowed; }
    </style>
</head>
<body class="antialiased">

    <div id="screen-login" class="screen active screen-card">
        <div class="screen-body text-center">
            <h2 class="text-3xl font-bold text-slate-800">AMEET</h2>
            <p class="text-slate-600 mt-2 mb-8">로그인 후 AI 집단지성 토론을 시작하세요.</p>
            <div id="login-form" class="max-w-sm mx-auto space-y-4">
                <input type="email" id="email-input" placeholder="이메일 주소 (user@example.com)" class="w-full p-3 border-slate-300 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" value="user@example.com">
                <input type="password" id="password-input" placeholder="비밀번호 (userpassword)" class="w-full p-3 border-slate-300 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" value="userpassword">
                <button id="login-button" class="btn btn-primary w-full">로그인</button>
                <p id="login-error" class="text-sm text-red-500 h-4"></p>
            </div>
        </div>
    </div>

    <div id="screen-topic" class="screen screen-card">
        <div class="screen-header">
            <span class="font-bold">주제 입력</span>
            <div class="flex items-center gap-4">
                <span id="user-email-display" class="text-sm font-medium text-slate-600"></span>
                <button id="logout-button" class="text-sm font-bold text-red-500 hover:underline">로그아웃</button>
            </div>
        </div>
        <div class="screen-body text-center">
            <h2 class="text-3xl font-bold text-slate-800">무엇에 대해 토론할까요?</h2>
            <p class="text-slate-600 mt-2 mb-8">AI 집단지성이 깊이 있는 통찰을 제공합니다.</p>
            <div class="bg-slate-50 p-6 rounded-xl border">
                <textarea id="topic-input" class="w-full h-28 p-3 border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base" placeholder="예: 테슬라의 6개월 뒤 주가 전망"></textarea>
                <div class="flex flex-col sm:flex-row justify-between items-center mt-4 gap-4">
                    <label class="flex items-center gap-2 text-sm text-slate-600 hover:text-primary cursor-pointer">
                        <input type="file" id="file-input" class="hidden">
                        📎 <span id="file-name-display">참고 파일 첨부 (TXT, PDF)</span>
                    </label>
                    <button id="start-analysis-button" class="btn btn-primary w-full sm:w-auto">분석 시작</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-analysis" class="screen screen-card">
        <div class="screen-header"><span>토론 준비: AI 분석 과정</span></div>
        <div class="screen-body">
            <div class="text-center mb-8">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mx-auto"></div>
                <h2 id="analysis-status-text" class="text-2xl font-bold text-slate-800 mt-6">주제를 분석하고 있습니다...</h2>
                <p class="text-slate-600 mt-2">최적의 토론을 위해 AI가 3단계에 걸쳐 준비합니다.</p>
            </div>
            <div class="relative w-full max-w-2xl mx-auto p-4">
                <div class="absolute top-1/2 left-0 w-full h-1 bg-slate-200 -translate-y-1/2"></div>
                <div id="progress-bar" class="absolute top-1/2 left-0 h-1 bg-blue-500 -translate-y-1/2 transition-all duration-1000" style="width: 15%;"></div>
                <div class="relative flex justify-between items-start">
                    <div id="step-1" class="text-center z-10">
                        <div class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center mx-auto font-bold text-xl ring-4 ring-white">1</div>
                        <p class="text-sm font-bold mt-3">주제 분석</p>
                        <p id="step-1-status" class="text-xs text-slate-500">쟁점 도출 중</p>
                    </div>
                    <div id="step-2" class="text-center z-10 opacity-50">
                        <div class="w-12 h-12 rounded-full bg-white border-2 border-slate-300 flex items-center justify-center mx-auto font-bold text-xl text-slate-400 ring-4 ring-white">2</div>
                        <p class="text-sm font-bold mt-3 text-slate-400">자료 수집</p>
                        <p id="step-2-status" class="text-xs text-slate-500">대기 중</p>
                    </div>
                    <div id="step-3" class="text-center z-10 opacity-50">
                        <div class="w-12 h-12 rounded-full bg-white border-2 border-slate-300 flex items-center justify-center mx-auto font-bold text-xl text-slate-400 ring-4 ring-white">3</div>
                        <p class="text-sm font-bold mt-3 text-slate-400">패널 선정</p>
                        <p id="step-3-status" class="text-xs text-slate-500">대기 중</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-jury" class="screen screen-card">
        <div class="screen-header"><span>[4] 배심원단 구성 완료</span></div>
        <div id="jury-container" class="screen-body">
            </div>
    </div>
    
    <script>
        // --- DOM Elements ---
        const loginScreen = document.getElementById('screen-login');
        const topicScreen = document.getElementById('screen-topic');
        const analysisScreen = document.getElementById('screen-analysis'); // 분석 화면 요소
        const juryScreen = document.getElementById('screen-jury');       // 배심원단 화면 요소
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const loginError = document.getElementById('login-error');
        const userEmailDisplay = document.getElementById('user-email-display');
        const topicInput = document.getElementById('topic-input');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name-display');
        const startAnalysisButton = document.getElementById('start-analysis-button');
        const juryContainer = document.getElementById('jury-container');

        // --- Global Variables ---
        let currentDiscussionId = null; // 현재 토론 ID를 저장할 전역 변수
        
        // --- Functions ---
        
        /**
         * 화면을 전환하는 함수
         * @param {string} screenId - 표시할 화면의 ID
         */
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        /**
         * 로그인 API를 호출하는 함수
         */
        async function handleLogin() {
            const email = emailInput.value;
            const password = passwordInput.value;

            // 입력값 검증
            if (!email || !password) {
                loginError.textContent = '이메일과 비밀번호를 모두 입력해주세요.';
                return;
            }

            // 로딩 상태 표시
            loginButton.disabled = true;
            loginButton.textContent = '로그인 중...';
            loginError.textContent = '';

            // API는 x-www-form-urlencoded 형식을 요구하므로 FormData를 사용
            const formData = new URLSearchParams();
            formData.append('username', email);
            formData.append('password', password);

            try {
                const response = await fetch(`/api/v1/login/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData,
                });

                if (response.ok) {
                    const data = await response.json();
                    // JWT 토큰을 localStorage에 저장
                    localStorage.setItem('accessToken', data.access_token);
                    localStorage.setItem('userEmail', email);

                    // 로그인 성공 후 UI 업데이트 및 화면 전환
                    console.log('로그인 성공:', data);
                    updateUIForLoggedInState();
                    showScreen('screen-topic');

                } else {
                    const errorData = await response.json();
                    loginError.textContent = errorData.detail || '로그인에 실패했습니다. 이메일 또는 비밀번호를 확인하세요.';
                    console.error('로그인 실패:', errorData);
                }
            } catch (error) {
                loginError.textContent = '서버에 연결할 수 없습니다. 잠시 후 다시 시도해주세요.';
                console.error('네트워크 오류:', error);
            } finally {
                // 로딩 상태 해제
                loginButton.disabled = false;
                loginButton.textContent = '로그인';
            }
        }

        /**
         * 로그아웃 처리 함수
         */
        function handleLogout() {
            // 저장된 토큰과 이메일 정보 삭제
            localStorage.removeItem('accessToken');
            localStorage.removeItem('userEmail');
            
            console.log('로그아웃 되었습니다.');
            
            // UI 업데이트 및 로그인 화면으로 전환
            updateUIForLoggedOutState();
            showScreen('screen-login');
        }

        /**
         * '분석 시작' 버튼 클릭 시 오케스트레이션 파이프라인을 실행하는 함수
         */
        async function handleOrchestration() {
            const topic = topicInput.value.trim();
            const file = fileInput.files[0];
            const token = localStorage.getItem('accessToken');

            if (!topic) {
                alert('토론할 주제를 입력해주세요.');
                return;
            }
            if (!token) {
                alert('로그인이 필요합니다.');
                showScreen('screen-login');
                return;
            }

            showScreen('screen-analysis');
            //runAnalysisAnimation();
            updateAnalysisStep(1, '주제 분석 중...'); // 1단계 시작

            const formData = new FormData();
            formData.append('topic', topic);
            if (file) {
                formData.append('file', file);
            }

            try {
                // 2. API 호출 시작
                updateAnalysisStep(2, '자료 수집 중...'); // 2단계 시작
                const response = await fetch('/api/v1/discussions/', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData,
                });

                if (response.status === 201) {
                    // 3. API 응답 성공 시 '3단계' 애니메이션 시작
                    updateAnalysisStep(3, '패널 선정 중...'); // 3단계 시작
                    const debateTeam = await response.json();
                    console.log('Orchestration 성공:', debateTeam);
                    
                    currentDiscussionId = debateTeam.discussion_id;
                    console.log('저장된 Discussion ID:', currentDiscussionId);

                    // 4. 잠시 후 최종 화면으로 전환
                    setTimeout(() => {
                        renderJuryScreen(debateTeam);
                        showScreen('screen-jury');
                    }, 1000); // 1초 후 전환

                } else {
                    const errorData = await response.json();
                    alert(`분석 중 오류가 발생했습니다: ${errorData.detail}`);
                    showScreen('screen-topic');
                }
            } catch (error) {
                alert('서버에 연결할 수 없습니다.');
                showScreen('screen-topic');
                console.error('Orchestration 네트워크 오류:', error);
            }
        }

        // 분석 단계별 UI 업데이트를 위한 헬퍼 함수
        function updateAnalysisStep(stepNumber, statusText) {
            const progressBar = document.getElementById('progress-bar');
            const analysisStatusText = document.getElementById('analysis-status-text');
            
            analysisStatusText.textContent = statusText;

            if (stepNumber === 1) {
                progressBar.style.width = '15%';
            } else if (stepNumber === 2) {
                progressBar.style.width = '50%';
                const step2Div = document.getElementById('step-2');
                step2Div.classList.remove('opacity-50');
                step2Div.querySelector('div').className = 'w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center mx-auto font-bold text-xl ring-4 ring-white';
                document.getElementById('step-1-status').textContent = '완료';
                document.getElementById('step-2-status').textContent = '진행 중';
            } else if (stepNumber === 3) {
                progressBar.style.width = '100%';
                const step3Div = document.getElementById('step-3');
                step3Div.classList.remove('opacity-50');
                step3Div.querySelector('div').className = 'w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center mx-auto font-bold text-xl ring-4 ring-white';
                document.getElementById('step-2-status').textContent = '완료';
                document.getElementById('step-3-status').textContent = '진행 중';
            }
        }

        /**
         * 분석 과정 3단계 애니메이션을 시뮬레이션하는 함수
         */
        /*
        function runAnalysisAnimation() {
            // UI 요소 가져오기
            const progressBar = document.getElementById('progress-bar');
            const analysisStatusText = document.getElementById('analysis-status-text');
            const steps = {
                1: { div: document.getElementById('step-1'), status: document.getElementById('step-1-status') },
                2: { div: document.getElementById('step-2'), status: document.getElementById('step-2-status') },
                3: { div: document.getElementById('step-3'), status: document.getElementById('step-3-status') }
            };

            // 2단계 진행
            setTimeout(() => {
                progressBar.style.width = '50%';
                analysisStatusText.textContent = '웹 검색 및 파일 분석 중...';
                steps[1].status.textContent = '완료';
                steps[2].div.classList.remove('opacity-50');
                steps[2].div.querySelector('div').className = 'w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center mx-auto font-bold text-xl ring-4 ring-white';
                steps[2].status.textContent = '자료 확보 중';
            }, 1500); // 1.5초 후

            // 3단계 진행
            setTimeout(() => {
                progressBar.style.width = '100%';
                analysisStatusText.textContent = '최적의 전문가 팀 구성 중...';
                steps[2].status.textContent = '완료';
                steps[3].div.classList.remove('opacity-50');
                steps[3].div.querySelector('div').className = 'w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center mx-auto font-bold text-xl ring-4 ring-white';
                steps[3].status.textContent = '선발 중';
            }, 3000); // 3초 후
        }
        */

        /**
         * API 응답을 받은 후 애니메이션을 완료하고 화면을 전환하는 함수
         * @param {object} debateTeam - API 응답 데이터
         */
        /*
        function finishAnalysisAnimation(debateTeam) {
             setTimeout(() => {
                renderJuryScreen(debateTeam);
                showScreen('screen-jury');
            }, 1000); // 마지막 단계 보여주고 1초 후 전환
        }
        */

        /**
         * API 응답 데이터를 기반으로 배심원단 확인 화면을 동적으로 생성하는 함수
         * @param {object} teamData - /orchestrate API의 응답 데이터 (DebateTeam)
         */
        function renderJuryScreen(teamData) {
            const iconMap = { "사회자": "🧑‍⚖️", "거시경제 전문가": "🌍", "산업 분석가": "🏭", "재무 분석가": "💹", "SNS 트렌드 분석가": "📱", "비판적 관점": "🤔", "워렌 버핏": "👴", "피터 린치": "👨‍💼", "스티브 잡스": "📱", "일론 머스크": "🚀", "심리학 전문가": "🧠", "미래학자": "🔭", "IT 전문가": "💻" };
            
            let juryHtml = '';
            teamData.jury.forEach(agent => {
                const icon = agent.icon || iconMap[agent.name] || '🤖';
                juryHtml += `
                    <div class="flex flex-col items-center text-center p-3 bg-white rounded-lg shadow-sm">
                        <span class="text-3xl">${icon}</span>
                        <p class="font-bold mt-2">${agent.name}</p>
                        <p class="text-xs text-slate-500 mt-1">${agent.model}</p>
                    </div>`;
            });

            const fullHtml = `
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-slate-800">배심원단 구성이 완료되었습니다.</h2>
                    <p class="text-slate-600 mt-2">'재판관'의 진행에 따라, 선발된 'AI 배심원단'이 심층 토론을 시작합니다.</p>
                </div>
                <div class="mb-8">
                    <div class="bg-amber-50 border-2 border-amber-400 p-4 rounded-xl flex flex-col sm:flex-row items-center gap-4">
                        <span class="text-5xl">${teamData.judge.icon || iconMap[teamData.judge.name] || '🧑‍⚖️'}</span>
                        <div class="text-center sm:text-left">
                            <h3 class="text-lg font-bold text-amber-800">${teamData.judge.name} (사회자)</h3>
                            <p class="text-slate-600 mt-1">${teamData.judge.model}</p>
                        </div>
                    </div>
                </div>
                <div class="border-2 border-slate-200 bg-slate-50 p-6 rounded-xl">
                    <h3 class="font-bold text-slate-700 text-center mb-4 text-lg">AI 배심원단</h3>
                    <p class="text-center text-sm text-slate-500 mb-4">${teamData.reason}</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">${juryHtml}</div>
                </div>
                <button id="start-debate-btn" class="btn btn-primary w-full mt-8">이 구성으로 토론 시작하기</button>
            `;
            juryContainer.innerHTML = fullHtml;
            
            // [참고] '토론 시작하기' 버튼의 기능은 다음 단계에서 구현하므로, 지금은 이벤트 리스너를 연결하지 않습니다.
        }
        
        /**
         * 로그인 상태에 따라 UI를 업데이트하는 함수
         */
        function updateUIForLoggedInState() {
            const userEmail = localStorage.getItem('userEmail');
            if (userEmail) {
                userEmailDisplay.textContent = userEmail;
            }
        }
        
        /**
         * 로그아웃 상태에 따라 UI를 업데이트하는 함수
         */
        function updateUIForLoggedOutState() {
             userEmailDisplay.textContent = '';
             emailInput.value = 'user@example.com';
             passwordInput.value = 'userpassword';
        }

        // --- Event Listeners ---
        loginButton.addEventListener('click', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        startAnalysisButton.addEventListener('click', handleOrchestration);

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
                fileNameDisplay.classList.add('font-semibold', 'text-primary');
            } else {
                fileNameDisplay.textContent = '참고 파일 첨부 (TXT, PDF)';
                fileNameDisplay.classList.remove('font-semibold', 'text-primary');
            }
        });

        // --- Initial Check ---
        // 페이지 로드 시, 저장된 토큰이 있는지 확인하여 로그인 상태 유지
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('accessToken');
            if (token) {
                console.log('저장된 토큰으로 로그인 상태 유지');
                updateUIForLoggedInState();
                showScreen('screen-topic');
            } else {
                showScreen('screen-login');
            }
        });

    </script>
</body>
</html>
