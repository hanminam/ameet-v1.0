<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMEET - AI Collective Intelligence Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .screen { display: none; }
        .screen.active { display: block; }
        .screen-card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 48rem; /* 768px */
            margin: 2rem;
            overflow: hidden;
        }
        .screen-header {
            background-color: #f8fafc;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 700;
            color: #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .screen-body { padding: 2rem; }
        .text-primary { color: #2563eb; }
        .btn { border-radius: 0.75rem; font-weight: 700; padding: 0.75rem 1.5rem; transition: all 0.2s ease; cursor: pointer; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .btn-primary:disabled { background-color: #93c5fd; cursor: not-allowed; }

        /* í† ë¡  íë¦„ë„ í™”ì‚´í‘œ ìŠ¤íƒ€ì¼ */
        .flow-line {
            position: absolute;
            height: 3px; /* ê¸°ë³¸ ë‘ê»˜ë¥¼ ì•½ê°„ ë‘ê»ê²Œ ì¡°ì • */
            transform-origin: 0 0;
            transition: all 0.2s ease-in-out; /* ë¶€ë“œëŸ¬ìš´ íš¨ê³¼ë¥¼ ìœ„í•œ íŠ¸ëœì§€ì…˜ */
            z-index: 10; /* ê¸°ë³¸ í™”ì‚´í‘œ z-index ì„¤ì • */
        }
        .flow-line::after {
            content: '';
            position: absolute;
            right: -1px;
            top: -3.5px; /* ë‘ê»˜ì— ë§ì¶° ìœ„ì¹˜ ì¡°ì • */
            border-style: solid;
            border-width: 0 3px 3px 0;
            display: inline-block;
            padding: 3.5px;
            transform: rotate(-45deg);
        }

        /* ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ë¹„í™œì„±í™”ëœ í™”ì‚´í‘œ ìŠ¤íƒ€ì¼ */
        .flow-line.dimmed {
            opacity: 0.15;
            z-index: 5; /* íë ¤ì§„ í™”ì‚´í‘œëŠ” ë’¤ë¡œ ë³´ëƒ„ */
        }

        /* ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ê°•ì¡°ë˜ëŠ” í™”ì‚´í‘œ ìŠ¤íƒ€ì¼ */
        .flow-line.highlighted {
            height: 5px; /* ë‘ê»˜ë¥¼ ë” ë‘ê»ê²Œ */
            opacity: 1;
            z-index: 20; /* ê°•ì¡°ëœ í™”ì‚´í‘œë¥¼ ê°€ì¥ ìœ„ë¡œ ë³´ëƒ„ */
        }
        .flow-line.highlighted::after {
            top: -4.5px; /* ê°•ì¡°ëœ ë‘ê»˜ì— ë§ì¶° ìœ„ì¹˜ ì¬ì¡°ì • */
        }

        /* ì—ì´ì „íŠ¸ë³„ í™”ì‚´í‘œ ìƒ‰ìƒ ì •ì˜ (7ê°œ) */
        .flow-line-color-0 { background-color: #ef4444; } /* red-500 */
        .flow-line-color-0::after { border-color: #ef4444; }
        .flow-line-color-1 { background-color: #3b82f6; } /* blue-500 */
        .flow-line-color-1::after { border-color: #3b82f6; }
        .flow-line-color-2 { background-color: #22c55e; } /* green-500 */
        .flow-line-color-2::after { border-color: #22c55e; }
        .flow-line-color-3 { background-color: #eab308; } /* yellow-500 */
        .flow-line-color-3::after { border-color: #eab308; }
        .flow-line-color-4 { background-color: #8b5cf6; } /* violet-500 */
        .flow-line-color-4::after { border-color: #8b5cf6; }
        .flow-line-color-5 { background-color: #ec4899; } /* pink-500 */
        .flow-line-color-5::after { border-color: #ec4899; }
        .flow-line-color-6 { background-color: #f97316; } /* orange-500 */
        .flow-line-color-6::after { border-color: #f97316; }
    </style>
</head>
<body class="antialiased">

    <div id="screen-login" class="screen active screen-card">
        <div class="screen-body text-center">
            <h2 class="text-3xl font-bold text-slate-800">AMEET</h2>
            <p class="text-slate-600 mt-2 mb-8">ë¡œê·¸ì¸ í›„ AI ì§‘ë‹¨ì§€ì„± í† ë¡ ì„ ì‹œì‘í•˜ì„¸ìš”.</p>
            <div id="login-form" class="max-w-sm mx-auto space-y-4">
                <input type="email" id="email-input" placeholder="ì´ë©”ì¼ ì£¼ì†Œ (user@example.com)" class="w-full p-3 border-slate-300 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" value="user@example.com">
                <input type="password" id="password-input" placeholder="ë¹„ë°€ë²ˆí˜¸ (userpassword)" class="w-full p-3 border-slate-300 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" value="userpassword">
                <button id="login-button" class="btn btn-primary w-full">ë¡œê·¸ì¸</button>
                <p id="login-error" class="text-sm text-red-500 h-4"></p>
            </div>
        </div>
    </div>

    <div id="screen-topic" class="screen screen-card">
        <div class="screen-header">
            <span class="font-bold">ì£¼ì œ ì…ë ¥</span>
            <div class="flex items-center gap-4">
                <span id="user-email-display" class="text-sm font-medium text-slate-600"></span>
                <button id="logout-button" class="text-sm font-bold text-red-500 hover:underline">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
        <div class="screen-body text-center">
            <h2 class="text-3xl font-bold text-slate-800">ë¬´ì—‡ì— ëŒ€í•´ í† ë¡ í• ê¹Œìš”?</h2>
            <p class="text-slate-600 mt-2 mb-8">AI ì§‘ë‹¨ì§€ì„±ì´ ê¹Šì´ ìˆëŠ” í†µì°°ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
            <div class="bg-slate-50 p-6 rounded-xl border">
                <textarea id="topic-input" class="w-full h-28 p-3 border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base" placeholder="ì˜ˆ: í…ŒìŠ¬ë¼ì˜ 6ê°œì›” ë’¤ ì£¼ê°€ ì „ë§"></textarea>
                <div class="flex flex-col sm:flex-row justify-between items-center mt-4 gap-4">
                    <label class="flex items-center gap-2 text-sm text-slate-600 hover:text-primary cursor-pointer">
                        <input type="file" id="file-input" class="hidden">
                        ğŸ“ <span id="file-name-display">ì°¸ê³  íŒŒì¼ ì²¨ë¶€ (TXT, PDF)</span>
                    </label>
                    <button id="start-analysis-button" class="btn btn-primary w-full sm:w-auto">ë¶„ì„ ì‹œì‘</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-analysis" class="screen screen-card">
        <div class="screen-header"><span>í† ë¡  ì¤€ë¹„: AI ë¶„ì„ ê³¼ì •</span></div>
        <div class="screen-body">
            <div class="text-center mb-8">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mx-auto"></div>
                <h2 id="analysis-status-text" class="text-2xl font-bold text-slate-800 mt-6">ì£¼ì œë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</h2>
                <p class="text-slate-600 mt-2">ìµœì ì˜ í† ë¡ ì„ ìœ„í•´ AIê°€ 3ë‹¨ê³„ì— ê±¸ì³ ì¤€ë¹„í•©ë‹ˆë‹¤.</p>
            </div>
            <div class="relative w-full max-w-2xl mx-auto p-4">
                <div class="absolute top-1/2 left-0 w-full h-1 bg-slate-200 -translate-y-1/2"></div>
                <div id="progress-bar" class="absolute top-1/2 left-0 h-1 bg-blue-500 -translate-y-1/2 transition-all duration-1000" style="width: 15%;"></div>
                <div class="relative flex justify-between items-start">
                    <div id="step-1" class="text-center z-10">
                        <div class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center mx-auto font-bold text-xl ring-4 ring-white">1</div>
                        <p class="text-sm font-bold mt-3">ì£¼ì œ ë¶„ì„</p>
                        <p id="step-1-status" class="text-xs text-slate-500">ìŸì  ë„ì¶œ ì¤‘</p>
                    </div>
                    <div id="step-2" class="text-center z-10 opacity-50">
                        <div class="w-12 h-12 rounded-full bg-white border-2 border-slate-300 flex items-center justify-center mx-auto font-bold text-xl text-slate-400 ring-4 ring-white">2</div>
                        <p class="text-sm font-bold mt-3 text-slate-400">ìë£Œ ìˆ˜ì§‘</p>
                        <p id="step-2-status" class="text-xs text-slate-500">ëŒ€ê¸° ì¤‘</p>
                    </div>
                    <div id="step-3" class="text-center z-10 opacity-50">
                        <div class="w-12 h-12 rounded-full bg-white border-2 border-slate-300 flex items-center justify-center mx-auto font-bold text-xl text-slate-400 ring-4 ring-white">3</div>
                        <p class="text-sm font-bold mt-3 text-slate-400">íŒ¨ë„ ì„ ì •</p>
                        <p id="step-3-status" class="text-xs text-slate-500">ëŒ€ê¸° ì¤‘</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-jury" class="screen screen-card">
        <div class="screen-header"><span>ë°°ì‹¬ì›ë‹¨ êµ¬ì„± ì™„ë£Œ</span></div>
        <div id="jury-container" class="screen-body">
            </div>
    </div>

    <div id="screen-5" class="screen screen-card" style="max-width: 80rem;">
        <div class="screen-header">
            <span>ì‹¤ì‹œê°„ í† ë¡ </span>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6 bg-slate-50">
            <div class="lg:col-span-2 h-[70vh] flex flex-col">
                <div id="chatbox" class="flex-1 overflow-y-auto space-y-6 p-4 border rounded-lg bg-white shadow-inner">
                    <div class="text-center text-slate-500">AI ì—ì´ì „íŠ¸ë“¤ì˜ ë°œì–¸ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...</div>
                </div>
                <div id="user-action-panel" class="pt-4"></div>
            </div>

            <div class="space-y-6">
                <div id="critical-hit-panel" class="bg-white border p-4 rounded-xl">
                    <h3 class="font-bold text-slate-700 text-lg mb-2">âš¡ ê²°ì •ì  ë°œì–¸</h3>
                    <p class="text-sm text-slate-700">ì§„í–‰ ì¤‘...</p>
                </div>
                <div class="bg-white border p-4 rounded-xl">
                    <h3 class="font-bold text-slate-700 text-lg mb-4">ğŸ”„ í† ë¡  íë¦„ë„</h3>
                    <div id="flow-diagram-container" class="relative">
                        <p class="text-sm text-slate-700">ì§„í–‰ ì¤‘...</p>
                    </div>
                </div>
                <div class="bg-white border p-4 rounded-xl">
                    <h3 class="font-bold text-slate-700 text-lg mb-4">ğŸ“Š ì—ì´ì „íŠ¸ ì…ì¥ ë³€í™”</h3>
                    <div id="stance-tracker" class="space-y-3">
                        <p class="text-sm text-slate-700">ì§„í–‰ ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-6" class="screen screen-card">
        <div class="screen-header"><span>ìµœì¢… ë¶„ì„ ë³´ê³ ì„œ</span></div>
        <div class="screen-body">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
                <h2 class="text-3xl font-bold text-slate-800">ìµœì¢… ë¶„ì„ ë³´ê³ ì„œ</h2>
                <button class="btn btn-secondary w-full sm:w-auto">ğŸ“¥ PDF ë‹¤ìš´ë¡œë“œ</button>
            </div>
            <div class="text-center p-8 border rounded-lg">
                <h3 class="text-xl font-bold">ë³´ê³ ì„œ ìƒì„± ì¤‘...</h3>
                <p class="text-slate-600 mt-2">í† ë¡ ì´ ì¢…ë£Œë˜ì—ˆìœ¼ë©°, ìµœì¢… ë³´ê³ ì„œê°€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìƒì„±ë˜ê³  ìˆìŠµë‹ˆë‹¤. ì™„ë£Œë˜ë©´ ì´ í™”ë©´ì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>
    
    <script>
        // --- DOM Elements ---
        const loginScreen = document.getElementById('screen-login');
        const topicScreen = document.getElementById('screen-topic');
        const analysisScreen = document.getElementById('screen-analysis'); // ë¶„ì„ í™”ë©´ ìš”ì†Œ
        const juryScreen = document.getElementById('screen-jury');       // ë°°ì‹¬ì›ë‹¨ í™”ë©´ ìš”ì†Œ
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const loginError = document.getElementById('login-error');
        const userEmailDisplay = document.getElementById('user-email-display');
        const topicInput = document.getElementById('topic-input');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name-display');
        const startAnalysisButton = document.getElementById('start-analysis-button');
        const juryContainer = document.getElementById('jury-container');

        // --- Global Variables ---
        let currentDiscussionId = null;     // í˜„ì¬ í† ë¡  IDë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
        let isPollingActive = false;        // í´ë§ ë£¨í”„ì˜ í™œì„± ìƒíƒœë¥¼ ê´€ë¦¬
        let displayedMessagesCount = 0;     // í™”ë©´ì— í‘œì‹œëœ ë©”ì‹œì§€ ìˆ˜
        let isRendering = false;
        
        // --- Functions ---
        
        /**
         * í™”ë©´ì„ ì „í™˜í•˜ëŠ” í•¨ìˆ˜
         * @param {string} screenId - í‘œì‹œí•  í™”ë©´ì˜ ID
         */
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        /**
         * ë¡œê·¸ì¸ APIë¥¼ í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜
         */
        async function handleLogin() {
            const email = emailInput.value;
            const password = passwordInput.value;

            // ì…ë ¥ê°’ ê²€ì¦
            if (!email || !password) {
                loginError.textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            loginButton.disabled = true;
            loginButton.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
            loginError.textContent = '';

            // APIëŠ” x-www-form-urlencoded í˜•ì‹ì„ ìš”êµ¬í•˜ë¯€ë¡œ FormDataë¥¼ ì‚¬ìš©
            const formData = new URLSearchParams();
            formData.append('username', email);
            formData.append('password', password);

            try {
                const response = await fetch(`/api/v1/login/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData,
                });

                if (response.ok) {
                    const data = await response.json();
                    // JWT í† í°ì„ localStorageì— ì €ì¥
                    localStorage.setItem('accessToken', data.access_token);
                    localStorage.setItem('userEmail', email);

                    // ë¡œê·¸ì¸ ì„±ê³µ í›„ UI ì—…ë°ì´íŠ¸ ë° í™”ë©´ ì „í™˜
                    console.log('ë¡œê·¸ì¸ ì„±ê³µ:', data);
                    updateUIForLoggedInState();
                    showScreen('screen-topic');

                } else {
                    const errorData = await response.json();
                    loginError.textContent = errorData.detail || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
                    console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', errorData);
                }
            } catch (error) {
                loginError.textContent = 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                console.error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
            } finally {
                // ë¡œë”© ìƒíƒœ í•´ì œ
                loginButton.disabled = false;
                loginButton.textContent = 'ë¡œê·¸ì¸';
            }
        }

        /**
         * ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ í•¨ìˆ˜
         */
        function handleLogout() {
            // ì €ì¥ëœ í† í°ê³¼ ì´ë©”ì¼ ì •ë³´ ì‚­ì œ
            localStorage.removeItem('accessToken');
            localStorage.removeItem('userEmail');
            
            console.log('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            // UI ì—…ë°ì´íŠ¸ ë° ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì „í™˜
            updateUIForLoggedOutState();
            showScreen('screen-login');
        }

        /**
         * 'ë¶„ì„ ì‹œì‘' ë²„íŠ¼ í´ë¦­ ì‹œ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜
         */
        async function handleOrchestration() {
            const topic = topicInput.value.trim();
            const file = fileInput.files[0];
            const token = localStorage.getItem('accessToken');

            if (!topic) {
                alert('í† ë¡ í•  ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                showScreen('screen-login');
                return;
            }

            showScreen('screen-analysis');
            //runAnalysisAnimation();
            updateAnalysisStep(1, 'ì£¼ì œ ë¶„ì„ ì¤‘...'); // 1ë‹¨ê³„ ì‹œì‘

            const formData = new FormData();
            formData.append('topic', topic);
            if (file) {
                formData.append('file', file);
            }

            try {
                // 2. API í˜¸ì¶œ ì‹œì‘
                updateAnalysisStep(2, 'ìë£Œ ìˆ˜ì§‘ ì¤‘...'); // 2ë‹¨ê³„ ì‹œì‘
                const response = await fetch('/api/v1/discussions/', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData,
                });

                if (response.status === 201) {
                    // 3. API ì‘ë‹µ ì„±ê³µ ì‹œ '3ë‹¨ê³„' ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
                    updateAnalysisStep(3, 'íŒ¨ë„ ì„ ì • ì¤‘...'); // 3ë‹¨ê³„ ì‹œì‘
                    const debateTeam = await response.json();
                    console.log('Orchestration ì„±ê³µ:', debateTeam);
                    
                    currentDiscussionId = debateTeam.discussion_id;
                    console.log('ì €ì¥ëœ Discussion ID:', currentDiscussionId);

                    // 4. ì ì‹œ í›„ ìµœì¢… í™”ë©´ìœ¼ë¡œ ì „í™˜
                    setTimeout(() => {
                        renderJuryScreen(debateTeam);
                        showScreen('screen-jury');
                    }, 1000); // 1ì´ˆ í›„ ì „í™˜

                } else {
                    const errorData = await response.json();
                    alert(`ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${errorData.detail}`);
                    showScreen('screen-topic');
                }
            } catch (error) {
                alert('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                showScreen('screen-topic');
                console.error('Orchestration ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
            }
        }

        // ë¶„ì„ ë‹¨ê³„ë³„ UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ í—¬í¼ í•¨ìˆ˜
        function updateAnalysisStep(stepNumber, statusText) {
            const progressBar = document.getElementById('progress-bar');
            const analysisStatusText = document.getElementById('analysis-status-text');
            
            analysisStatusText.textContent = statusText;

            if (stepNumber === 1) {
                progressBar.style.width = '15%';
            } else if (stepNumber === 2) {
                progressBar.style.width = '50%';
                const step2Div = document.getElementById('step-2');
                step2Div.classList.remove('opacity-50');
                step2Div.querySelector('div').className = 'w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center mx-auto font-bold text-xl ring-4 ring-white';
                document.getElementById('step-1-status').textContent = 'ì™„ë£Œ';
                document.getElementById('step-2-status').textContent = 'ì§„í–‰ ì¤‘';
            } else if (stepNumber === 3) {
                progressBar.style.width = '100%';
                const step3Div = document.getElementById('step-3');
                step3Div.classList.remove('opacity-50');
                step3Div.querySelector('div').className = 'w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center mx-auto font-bold text-xl ring-4 ring-white';
                document.getElementById('step-2-status').textContent = 'ì™„ë£Œ';
                document.getElementById('step-3-status').textContent = 'ì§„í–‰ ì¤‘';
            }
        }

        /**
         * ë¶„ì„ ê³¼ì • 3ë‹¨ê³„ ì• ë‹ˆë©”ì´ì…˜ì„ ì‹œë®¬ë ˆì´ì…˜í•˜ëŠ” í•¨ìˆ˜
         */
        /*
        function runAnalysisAnimation() {
            // UI ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            const progressBar = document.getElementById('progress-bar');
            const analysisStatusText = document.getElementById('analysis-status-text');
            const steps = {
                1: { div: document.getElementById('step-1'), status: document.getElementById('step-1-status') },
                2: { div: document.getElementById('step-2'), status: document.getElementById('step-2-status') },
                3: { div: document.getElementById('step-3'), status: document.getElementById('step-3-status') }
            };

            // 2ë‹¨ê³„ ì§„í–‰
            setTimeout(() => {
                progressBar.style.width = '50%';
                analysisStatusText.textContent = 'ì›¹ ê²€ìƒ‰ ë° íŒŒì¼ ë¶„ì„ ì¤‘...';
                steps[1].status.textContent = 'ì™„ë£Œ';
                steps[2].div.classList.remove('opacity-50');
                steps[2].div.querySelector('div').className = 'w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center mx-auto font-bold text-xl ring-4 ring-white';
                steps[2].status.textContent = 'ìë£Œ í™•ë³´ ì¤‘';
            }, 1500); // 1.5ì´ˆ í›„

            // 3ë‹¨ê³„ ì§„í–‰
            setTimeout(() => {
                progressBar.style.width = '100%';
                analysisStatusText.textContent = 'ìµœì ì˜ ì „ë¬¸ê°€ íŒ€ êµ¬ì„± ì¤‘...';
                steps[2].status.textContent = 'ì™„ë£Œ';
                steps[3].div.classList.remove('opacity-50');
                steps[3].div.querySelector('div').className = 'w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center mx-auto font-bold text-xl ring-4 ring-white';
                steps[3].status.textContent = 'ì„ ë°œ ì¤‘';
            }, 3000); // 3ì´ˆ í›„
        }
        */

        /**
         * API ì‘ë‹µì„ ë°›ì€ í›„ ì• ë‹ˆë©”ì´ì…˜ì„ ì™„ë£Œí•˜ê³  í™”ë©´ì„ ì „í™˜í•˜ëŠ” í•¨ìˆ˜
         * @param {object} debateTeam - API ì‘ë‹µ ë°ì´í„°
         */
        /*
        function finishAnalysisAnimation(debateTeam) {
             setTimeout(() => {
                renderJuryScreen(debateTeam);
                showScreen('screen-jury');
            }, 1000); // ë§ˆì§€ë§‰ ë‹¨ê³„ ë³´ì—¬ì£¼ê³  1ì´ˆ í›„ ì „í™˜
        }
        */

        /**
         * API ì‘ë‹µ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë°°ì‹¬ì›ë‹¨ í™•ì¸ í™”ë©´ì„ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
         * @param {object} teamData - /orchestrate APIì˜ ì‘ë‹µ ë°ì´í„° (DebateTeam)
         */
        function renderJuryScreen(teamData) {
            const iconMap = { 
                "ì‚¬íšŒì": "ğŸ§‘", "ê±°ì‹œê²½ì œ ì „ë¬¸ê°€": "ğŸŒ", "ì‚°ì—… ë¶„ì„ê°€": "ğŸ­", 
                "ì¬ë¬´ ë¶„ì„ê°€": "ğŸ’¹", "SNS íŠ¸ë Œë“œ ë¶„ì„ê°€": "ğŸ“±", "ë¹„íŒì  ê´€ì ": "ğŸ¤”", 
                "ì›Œë Œ ë²„í•": "ğŸ‘´", "í”¼í„° ë¦°ì¹˜": "ğŸ‘¨â€ğŸ’¼", "ìŠ¤í‹°ë¸Œ ì¡ìŠ¤": "ğŸ“±", 
                "ì¼ë¡  ë¨¸ìŠ¤í¬": "ğŸš€", "ì‹¬ë¦¬í•™ ì „ë¬¸ê°€": "ğŸ§ ", "ë¯¸ë˜í•™ì": "ğŸ”­", "IT ì „ë¬¸ê°€": "ğŸ’»" 
            };
            
            let juryHtml = '';
            teamData.jury.forEach(agent => {
                // agent.iconì„ ìš°ì„ ì ìœ¼ë¡œ ì‚¬ìš©í•˜ê³ , ì—†ìœ¼ë©´ iconMapì„ ì°¸ì¡°í•˜ëŠ” ë¡œì§ìœ¼ë¡œ ë³€ê²½
                const icon = agent.icon || iconMap[agent.name] || 'ğŸ¤–';
                juryHtml += `
                    <div class="flex flex-col items-center text-center p-3 bg-white rounded-lg shadow-sm">
                        <span class="text-3xl">${icon}</span>
                        <p class="font-bold mt-2">${agent.name}</p>
                        <p class="text-xs text-slate-500 mt-1">${agent.model}</p>
                    </div>`;
            });

            const judgeIcon = teamData.judge.icon || iconMap[teamData.judge.name] || 'ğŸ§‘';
            const judgeName = teamData.judge.name;

            const fullHtml = `
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-slate-800">ì „ë¬¸ê°€ ì—ì´ì „íŠ¸ êµ¬ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</h2>
                    <p class="text-slate-600 mt-2">'ì‚¬íšŒì'ì˜ ì§„í–‰ì— ë”°ë¼, ì„ ë°œëœ 'AI ì „ë¬¸ê°€'ë“¤ì˜ ì‹¬ì¸µ í† ë¡ ì„ ì‹œì‘í•©ë‹ˆë‹¤.</p>
                </div>
                <div class="mb-8">
                    <div class="bg-amber-50 border-2 border-amber-400 p-4 rounded-xl flex flex-col sm:flex-row items-center gap-4">
                        <span class="text-5xl">${teamData.judge.icon || iconMap[teamData.judge.name] || 'ğŸ§‘'}</span>
                        <div class="text-center sm:text-left">
                            <h3 class="text-lg font-bold text-amber-800">ì‚¬íšŒì</h3>
                            <p class="text-slate-600 mt-1">${teamData.judge.model}</p>
                        </div>
                    </div>
                </div>
                <div class="border-2 border-slate-200 bg-slate-50 p-6 rounded-xl">
                    <h3 class="font-bold text-slate-700 text-center mb-4 text-lg">AI ì „ë¬¸ê°€</h3>
                    <p class="text-center text-sm text-slate-500 mb-4">${teamData.reason}</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">${juryHtml}</div>
                </div>
                <button id="start-debate-btn" class="btn btn-primary w-full mt-8">ì´ êµ¬ì„±ìœ¼ë¡œ í† ë¡  ì‹œì‘í•˜ê¸°</button>
            `;
            juryContainer.innerHTML = fullHtml;
            
            // 'í† ë¡  ì‹œì‘í•˜ê¸°' ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ 
            document.getElementById('start-debate-btn').addEventListener('click', startDebate);
        }

        /**
         * 'í† ë¡  ì‹œì‘í•˜ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ, ë°±ì—”ë“œì— í† ë¡  ì‹¤í–‰ì„ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜
         */
        async function startDebate() {

            if (!currentDiscussionId) {
                alert('ì˜¤ë¥˜: í† ë¡  IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const token = localStorage.getItem('accessToken');
            const startDebateBtn = document.getElementById('start-debate-btn');

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            startDebateBtn.disabled = true;
            startDebateBtn.textContent = 'í† ë¡ ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...';

            try {
                const response = await fetch(`/api/v1/discussions/${currentDiscussionId}/turns`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_vote: null }) // ì²« ì‹œì‘ì´ë¯€ë¡œ íˆ¬í‘œ ê°’ì€ null
                });

                if (response.status === 202) { // 202 Accepted
                    console.log('ë°±ê·¸ë¼ìš´ë“œ í† ë¡  ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    displayedMessagesCount = 0; // ìƒˆ í† ë¡  ì‹œì‘ ì‹œ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
                    const chatbox = document.getElementById('chatbox');
                    chatbox.innerHTML = '<div id="waiting-message" class="text-center text-slate-500">AI ì—ì´ì „íŠ¸ë“¤ì˜ ë°œì–¸ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...</div>'; // ì´ˆê¸° ë©”ì‹œì§€ ì„¤ì •
                    // ë‹¤ìŒ ë‹¨ê³„: ì‹¤ì‹œê°„ í† ë¡  í™”ë©´ìœ¼ë¡œ ì „í™˜
                    showScreen('screen-5'); 

                    // ì±„íŒ…ì°½ì„ ë¹„ìš°ëŠ” ëŒ€ì‹ , ë²”ìš© "ì…ë ¥ ì¤‘" ì¸ë””ì¼€ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
                    showGeneralTypingIndicator(true); 

                    startPolling(currentDiscussionId); // í´ë§ ì‹œì‘
                } else {
                    const errorData = await response.json();
                    alert(`í† ë¡  ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${errorData.detail}`);
                    startDebateBtn.disabled = false;
                    startDebateBtn.textContent = 'ì´ êµ¬ì„±ìœ¼ë¡œ í† ë¡  ì‹œì‘í•˜ê¸°';
                }
            } catch (error) {
                alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                console.error('í† ë¡  ì‹œì‘ API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                startDebateBtn.disabled = false;
                startDebateBtn.textContent = 'ì´ êµ¬ì„±ìœ¼ë¡œ í† ë¡  ì‹œì‘í•˜ê¸°';
            }
        }

        /**
         * ì£¼ê¸°ì ìœ¼ë¡œ í† ë¡  ìƒíƒœë¥¼ ì„œë²„ì— ìš”ì²­í•˜ëŠ” í´ë§ì„ ì‹œì‘í•˜ëŠ” í•¨ìˆ˜
         */
        function startPolling(discussionId) {
            if (isPollingActive) {
                return; // ì´ë¯¸ í´ë§ì´ ì§„í–‰ ì¤‘ì´ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            }
            isPollingActive = true;
            console.log(`Polling started for ${discussionId}`);
            pollDiscussionStatus(discussionId); // ì¦‰ì‹œ ì²« ë²ˆì§¸ í´ë§ ì‹œì‘
        }

        /**
         * ì„œë²„ì— í† ë¡  ìƒíƒœë¥¼ GETìœ¼ë¡œ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜
         */
        async function pollDiscussionStatus(discussionId) {
            if (!isPollingActive) {
                console.log("Polling was stopped externally.");
                return;
            }

            const token = localStorage.getItem('accessToken');
            try {
                const response = await fetch(`/api/v1/discussions/${discussionId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const discussionData = await response.json();
                    
                    // [ë¡œê·¸ ì¶”ê°€] ë°±ì—”ë“œë¡œë¶€í„° ë°›ì€ ë°ì´í„° ì›ë³¸ì„ ê·¸ëŒ€ë¡œ ì½˜ì†”ì— ì¶œë ¥
                    //console.log('%c[Polling Response Received]', 'color: blue; font-weight: bold;', discussionData);
                    
                    await updateTranscript(discussionData.transcript, discussionData.participants);

                    if (discussionData.status === 'waiting_for_vote') {
                        console.log('%c[Polling] Status is "waiting_for_vote". Stopping poll.', 'color: green; font-weight: bold;');
                        isPollingActive = false;
                        
                        renderUxPanels(discussionData); 
                        
                        // [ë¡œê·¸ ì¶”ê°€] renderUserActionPanel í•¨ìˆ˜ í˜¸ì¶œ ì§ì „ ë¡œê·¸
                        console.log("[ë¡œê·¸ ì¶”ê°€] renderUserActionPanel í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.");
                        renderUserActionPanel(discussionData); 
                    } else if (discussionData.status === 'completed' || discussionData.status === 'failed') {
                        console.log(`%c[Polling] Discussion finished with status: ${discussionData.status}. Stopping poll.`, 'color: red; font-weight: bold;');
                        isPollingActive = false;
                        showScreen('screen-6');
                    } else {
                        // [ë¡œê·¸ ì¶”ê°€] í´ë§ ê³„ì† ì§„í–‰ ìƒí™©
                        console.log(`[Polling] Status is "${discussionData.status}". Continuing poll in 3 seconds.`);
                        setTimeout(() => pollDiscussionStatus(discussionId), 3000);
                    }
                } else {
                    console.error('Polling failed with status:', response.status);
                    isPollingActive = false;
                }
            } catch (error) {
                console.error('Polling network error:', error);
                isPollingActive = false;
            }
        }

        /**
         * ëª¨ë“  UX íŒ¨ë„ì˜ ë Œë”ë§ì„ ê´€ë¦¬í•˜ëŠ” í•¨ìˆ˜
         */
        function renderUxPanels(data) {
            if (data.round_summary) {
                renderCriticalUtterance(data.round_summary.critical_utterance);
                renderStanceChanges(data.round_summary.stance_changes, data.participants);
            }
            if (data.flow_data) {
                renderFlowDiagram(data.flow_data.interactions, data.participants);
            }
        }

        /**
         * 'ê²°ì •ì  ë°œì–¸' íŒ¨ë„ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
         */
        function renderCriticalUtterance(utterance) {
            const panel = document.getElementById('critical-hit-panel'); // UIì— í•´ë‹¹ IDê°€ ìˆì–´ì•¼ í•¨
            if (!panel || !utterance) return;
            panel.innerHTML = `
                <h3 class="font-bold text-yellow-800 text-lg mb-2">âš¡ ê²°ì •ì  ë°œì–¸</h3>
                <div class="text-sm text-slate-700">
                    <p class="font-semibold">[${utterance.agent_name}]</p>
                    <p class="mt-1">"${utterance.message}"</p>
                </div>`;
        }

        /**
         * 'ì—ì´ì „íŠ¸ ì…ì¥ ë³€í™”' íŒ¨ë„ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
         */
        function renderStanceChanges(stanceChanges, participants) {
            const panel = document.getElementById('stance-tracker');
            if (!panel) return;

            // [ìˆ˜ì •] stanceChanges ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆì„ ê²½ìš° ì´ˆê¸° ë©”ì‹œì§€ í‘œì‹œ
            if (!stanceChanges || stanceChanges.length === 0) {
                panel.innerHTML = '<p class="text-sm text-slate-500 text-center">ë‹¤ìŒ ë¼ìš´ë“œë¶€í„° ì…ì¥ ë³€í™”ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>';
                return;
            }

            const participantMap = getParticipantMap(participants);
            let html = '';
            stanceChanges.forEach(change => {
                html += `
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">${participantMap[change.agent_name]?.icon || 'ğŸ¤–'}</span>
                            <span class="font-semibold">${change.agent_name}</span>
                        </div>
                        <div class="font-bold flex items-center gap-1.5">
                        ${change.icon} ${change.change}
                        </div>
                    </div>`;
            });
            panel.innerHTML = html;
        }

        /**
         * 'í† ë¡  íë¦„ë„' íŒ¨ë„ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
         */
        function renderFlowDiagram(interactions, participants) {
            const container = document.getElementById('flow-diagram-container');
            if (!container || !interactions) return;

            const participantMap = getParticipantMap(participants);
            const juryNames = participants
                .filter(p => p.name !== 'ì¬íŒê´€' && interactions.some(i => i.from === p.name || i.to === p.name))
                .map(p => p.name);

            // 1. ì—ì´ì „íŠ¸ ì•„ì´ì½˜ê³¼ ì´ë¦„ ë…¸ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (z-index ì œê±°ë¨)
            let agentHtml = '<div class="grid grid-cols-2 gap-x-8 gap-y-6">';
            juryNames.forEach(name => {
                const safeId = `agent-node-${name.replace(/[^a-zA-Z0-9]/g, '-')}`;
                agentHtml += `
                    <div id="${safeId}" class="flex flex-col items-center text-center cursor-pointer">
                        <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-2xl">${participantMap[name].icon}</div>
                        <p class="text-xs font-bold mt-1">${name}</p>
                    </div>`;
            });
            agentHtml += '</div>';
            container.innerHTML = agentHtml;

            // 2. DOM ë Œë”ë§ í›„ í™”ì‚´í‘œë¥¼ ê·¸ë¦¬ê³ , ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
            setTimeout(() => {
                const lines = []; 
                const colorClasses = Array.from({ length: 7 }, (_, i) => `flow-line-color-${i}`);

                interactions.forEach(flow => {
                    const fromId = `agent-node-${flow.from.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    const toId = `agent-node-${flow.to.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    const fromEl = document.getElementById(fromId);
                    const toEl = document.getElementById(toId);

                    if (fromEl && toEl) {
                        const colorIndex = juryNames.indexOf(flow.from) % colorClasses.length;
                        const colorClass = colorClasses[colorIndex];
                        
                        const line = createFlowLine(fromEl, toEl, colorClass);
                        line.dataset.from = flow.from;
                        line.dataset.to = flow.to;
                        
                        container.appendChild(line);
                        lines.push(line);
                    }
                });

                juryNames.forEach(name => {
                    const safeId = `agent-node-${name.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    const agentNode = document.getElementById(safeId);
                    if (agentNode) {
                        agentNode.addEventListener('mouseover', () => {
                            lines.forEach(line => {
                                if (line.dataset.from === name || line.dataset.to === name) {
                                    line.classList.remove('dimmed');
                                    line.classList.add('highlighted');
                                } else { 
                                    line.classList.add('dimmed');
                                    line.classList.remove('highlighted');
                                }
                            });
                        });
                        agentNode.addEventListener('mouseout', () => {
                            lines.forEach(line => {
                                line.classList.remove('dimmed', 'highlighted');
                            });
                        });
                    }
                });
            }, 100);
        }

        /**
         * í† ë¡  íë¦„ë„ í™”ì‚´í‘œë¥¼ ê·¸ë¦¬ëŠ” í—¬í¼ í•¨ìˆ˜
         */
        /**
         * ë‘ HTML ìš”ì†Œ(el1, el2)ë¥¼ ì—°ê²°í•˜ëŠ” í™”ì‚´í‘œ ì„ (div)ì„ ìƒì„±í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
         * @param {HTMLElement} el1 - ì‹œì‘ ìš”ì†Œ
         * @param {HTMLElement} el2 - ë„ì°© ìš”ì†Œ
         * @returns {HTMLElement} - ìŠ¤íƒ€ì¼ì´ ì ìš©ëœ í™”ì‚´í‘œ ì„  div ìš”ì†Œ
         */
        function createFlowLine(el1, el2, colorClass) {
            // 1. í•„ìš”í•œ ìš”ì†Œ(ì•„ì´ì½˜)ì™€ ë¶€ëª¨ ì»¨í…Œì´ë„ˆì˜ ì¢Œí‘œ ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const containerRect = el1.closest('#flow-diagram-container').getBoundingClientRect();
            const icon1 = el1.querySelector('div:first-child');
            const icon2 = el2.querySelector('div:first-child');
            const icon1Rect = icon1.getBoundingClientRect();
            const icon2Rect = icon2.getBoundingClientRect();

            // 2. ê° ì•„ì´ì½˜ì˜ 'ì¤‘ì•™'ì„ ì‹œì‘ì ê³¼ ëì ìœ¼ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤.
            const x1 = icon1Rect.left + icon1Rect.width / 2 - containerRect.left;
            const y1 = icon1Rect.top + icon1Rect.height / 2 - containerRect.top;
            const x2 = icon2Rect.left + icon2Rect.width / 2 - containerRect.left;
            const y2 = icon2Rect.top + icon2Rect.height / 2 - containerRect.top;

            // 3. ê³„ì‚°ëœ ì¢Œí‘œë¥¼ ë°”íƒ•ìœ¼ë¡œ í™”ì‚´í‘œì˜ ê¸¸ì´ì™€ ê°ë„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
            const length = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
            const angle = Math.atan2(y2 - y1, x2 - x1) * (180 / Math.PI);
            
            // 4. ìŠ¤íƒ€ì¼ì´ ì ìš©ëœ í™”ì‚´í‘œ div ìš”ì†Œë¥¼ ìƒì„±í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
            const line = document.createElement('div');
            line.className = `flow-line ${colorClass}`;
            line.style.width = `${length}px`;
            line.style.left = `${x1}px`;
            line.style.top = `${y1}px`;
            line.style.transform = `rotate(${angle}deg)`;
            
            return line;
        }

        /**
         * ì‚¬ìš©ì ì•¡ì…˜ íŒ¨ë„(íˆ¬í‘œ, ë‹¤ìŒ í–‰ë™ ë²„íŠ¼)ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
         */
        function renderUserActionPanel(discussionData) {
            const actionPanel = document.getElementById('user-action-panel');
            if (!actionPanel) {
                // [ë¡œê·¸ ì¶”ê°€]
                console.error("[ë¡œê·¸ ì˜¤ë¥˜] 'user-action-panel' ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const voteData = discussionData.current_vote;
            
            // [ë¡œê·¸ ì¶”ê°€] ìˆ˜ì‹ ëœ voteDataë¥¼ ìì„¸íˆ ê²€ì‚¬
            console.log("[ë¡œê·¸ ì¶”ê°€] renderUserActionPanel ë‚´ë¶€ voteData:", voteData);
            if (voteData) {
                console.log(`[ë¡œê·¸ ì¶”ê°€] voteData.topic: ${voteData.topic}`);
                console.log(`[ë¡œê·¸ ì¶”ê°€] voteData.options: ${JSON.stringify(voteData.options)}`);
                console.log(`[ë¡œê·¸ ì¶”ê°€] Array.isArray(voteData.options): ${Array.isArray(voteData.options)}`);
            }

            // [ìˆ˜ì •] ë Œë”ë§ ì¡°ê±´ ê²€ì‚¬ ê°•í™” ë° ë¡œê·¸ ì¶”ê°€
            if (voteData && voteData.topic && Array.isArray(voteData.options) && voteData.options.length > 0) {
                console.log('%c[ë¡œê·¸ ì„±ê³µ] íˆ¬í‘œ ë°ì´í„°ê°€ ìœ íš¨í•˜ì—¬ íˆ¬í‘œ UIë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.', 'color: green');
                let optionsHtml = '';
                voteData.options.forEach(option => {
                    const optionText = String(option);
                    optionsHtml += `<button class="btn btn-subtle vote-option" data-vote="${optionText}">${optionText}</button>`;
                });
                actionPanel.innerHTML = `
                    <div class="bg-amber-100 border-l-4 border-amber-500 p-4 rounded-r-lg shadow-lg animate-fade-in">
                        <p class="font-bold text-amber-800">ì‚¬íšŒìì˜ íˆ¬í‘œ ì œì•ˆ (Round ${discussionData.turn_number})</p>
                        <p class="mt-2 text-base text-amber-900">"${voteData.topic}"</p>
                        <div id="vote-options-container" class="flex flex-wrap gap-3 justify-center mt-4">
                            ${optionsHtml}
                        </div>
                    </div>
                    <div class="flex justify-center gap-4 mt-6">
                        <button id="next-round-btn" class="btn btn-primary">íˆ¬í‘œí•˜ê³  ë‹¤ìŒ ë¼ìš´ë“œ ì§„í–‰</button>
                        <button id="end-debate-btn" class="btn btn-secondary">ì´ëŒ€ë¡œ í† ë¡  ì¢…ë£Œ</button>
                    </div>
                `;
            } else {
                console.warn('%c[ë¡œê·¸ ê²½ê³ ] íˆ¬í‘œ ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•Šì•„ ê¸°ë³¸ ë²„íŠ¼ì„ ë Œë”ë§í•©ë‹ˆë‹¤.', 'color: orange');
                actionPanel.innerHTML = `
                    <div class="flex justify-center gap-4 mt-6">
                        <button id="next-round-btn" class="btn btn-primary">ë‹¤ìŒ ë¼ìš´ë“œ ì§„í–‰</button>
                        <button id="end-debate-btn" class="btn btn-secondary">ì´ëŒ€ë¡œ í† ë¡  ì¢…ë£Œ</button>
                    </div>`;
            }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            document.getElementById('next-round-btn').addEventListener('click', handleNextRound);
            document.getElementById('end-debate-btn').addEventListener('click', handleEndDebate);
            
            const voteOptionsContainer = document.getElementById('vote-options-container');
            if (voteOptionsContainer) {
                voteOptionsContainer.addEventListener('click', (event) => {
                    if (event.target.classList.contains('vote-option')) {
                        voteOptionsContainer.querySelectorAll('.vote-option').forEach(btn => {
                            btn.classList.remove('bg-blue-600', 'text-white');
                        });
                        event.target.classList.add('bg-blue-600', 'text-white');
                    }
                });
            }
        }

        /**
         * 'ë‹¤ìŒ ë¼ìš´ë“œ ì§„í–‰' ë²„íŠ¼ì˜ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
         */
        async function handleNextRound() {
            const nextRoundBtn = document.getElementById('next-round-btn');
            nextRoundBtn.disabled = true;
            nextRoundBtn.textContent = 'ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...';

            const selectedOption = document.querySelector('.vote-option.bg-blue-600');
            const userVote = selectedOption ? selectedOption.dataset.vote : null;
            console.log(`ë‹¤ìŒ ë¼ìš´ë“œ ì‹œì‘. ì‚¬ìš©ì íˆ¬í‘œ: ${userVote}`);

            const token = localStorage.getItem('accessToken');
            try {
                const response = await fetch(`/api/v1/discussions/${currentDiscussionId}/turns`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_vote: userVote })
                });

                if (response.status === 202) {
                    document.getElementById('user-action-panel').innerHTML = ''; // ì•¡ì…˜ íŒ¨ë„ ë¹„ìš°ê¸°

                    // ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ìœ„í•´ ë²”ìš© "ì…ë ¥ ì¤‘" ì¸ë””ì¼€ì´í„°ë¥¼ ë‹¤ì‹œ í‘œì‹œí•©ë‹ˆë‹¤.
                    showGeneralTypingIndicator(true);

                    startPolling(currentDiscussionId); // ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ìœ„í•´ í´ë§ ë‹¤ì‹œ ì‹œì‘
                } else {
                    const errorData = await response.json();
                    alert(`ë‹¤ìŒ ë¼ìš´ë“œ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${errorData.detail}`);
                    nextRoundBtn.disabled = false;
                    nextRoundBtn.textContent = 'ë‹¤ìŒ ë¼ìš´ë“œ ì§„í–‰';
                }
            } catch (error) {
                alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                nextRoundBtn.disabled = false;
                nextRoundBtn.textContent = 'ë‹¤ìŒ ë¼ìš´ë“œ ì§„í–‰';
            }
        }

        /**
         * 'í† ë¡  ì¢…ë£Œ' ë²„íŠ¼ì˜ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
         */
        async function handleEndDebate() {
            console.log("í† ë¡ ì„ ì¢…ë£Œí•˜ê³  ë³´ê³ ì„œ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
            isPollingActive = false; // ì§„í–‰ ì¤‘ì¸ í´ë§ ì¦‰ì‹œ ì¤‘ë‹¨

            const endDebateBtn = document.getElementById('end-debate-btn');
            if (endDebateBtn) {
                endDebateBtn.disabled = true;
                endDebateBtn.textContent = 'ì¢…ë£Œ ì²˜ë¦¬ ì¤‘...';
            }

            if (!currentDiscussionId) {
                showScreen('screen-6'); // í† ë¡  IDê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ í™”ë©´ë§Œ ì „í™˜
                return;
            }

            const token = localStorage.getItem('accessToken');
            try {
                // ë°±ì—”ë“œì— í† ë¡  ì™„ë£Œë¥¼ ì•Œë¦¬ëŠ” API í˜¸ì¶œ
                const response = await fetch(`/api/v1/discussions/${currentDiscussionId}/complete`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    console.log("ì„œë²„ì— í† ë¡  ì™„ë£Œ ìƒíƒœê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆê³ , ì„¸ì…˜ ë°ì´í„°ê°€ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                    const errorData = await response.json();
                    console.error("ì„œë²„ì— í† ë¡  ì™„ë£Œë¥¼ ì•Œë¦¬ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", errorData.detail);
                }
            } catch (error) {
                console.error("í† ë¡  ì™„ë£Œ API í˜¸ì¶œ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:", error);
            } finally {
                // API í˜¸ì¶œ ì„±ê³µ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ì‚¬ìš©ìëŠ” ë³´ê³ ì„œ í™”ë©´ìœ¼ë¡œ ì´ë™
                showScreen('screen-6'); 
            }
        }

        /**
         * ëŒ€í™”ë¡ ë°ì´í„°ë¥¼ ë°›ì•„ì™€ ì±„íŒ…ì°½ì— ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
         */
        function renderTranscript(transcript, participants) {
            const chatbox = document.getElementById('chatbox');
            if (!chatbox) return;

            // ì°¸ê°€ì ëª©ë¡ì—ì„œ ì´ë¦„ê³¼ ì•„ì´ì½˜ì„ ë§¤í•‘
            const participantMap = {};
            if (participants) {
                participants.forEach(p => {
                    participantMap[p.name] = { icon: p.icon || 'ğŸ¤–' };
                });
            }

            let html = '';
            if (transcript.length === 0) {
                html = '<div class="text-center text-slate-500">AI ì—ì´ì „íŠ¸ë“¤ì˜ ë°œì–¸ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...</div>';
            } else {
                transcript.forEach(turn => {
                    const agentName = turn.agent_name;
                    const message = turn.message.replace(/\n/g, '<br>'); // ì¤„ë°”ê¿ˆ ì²˜ë¦¬
                    const icon = participantMap[agentName]?.icon || 'ğŸ¤–';

                    html += `
                        <div class="flex gap-3 my-4 animate-fade-in">
                            <div class="w-10 h-10 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center text-xl">${icon}</div>
                            <div>
                                <p class="text-sm font-bold text-slate-800">${agentName}</p>
                                <div class="bg-slate-100 p-3 rounded-lg mt-1 text-base inline-block">${message}</div>
                            </div>
                        </div>
                    `;
                });
            }
            chatbox.innerHTML = html;
            chatbox.scrollTop = chatbox.scrollHeight; // ìë™ ìŠ¤í¬ë¡¤
        }

        /**
         * ìˆ˜ì‹ ëœ ëŒ€í™”ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ìƒˆ ë©”ì‹œì§€ë§Œ ìˆœì°¨ì ìœ¼ë¡œ í™”ë©´ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
         */
        async function updateTranscript(transcript, participants) {
            if (!transcript || transcript.length <= displayedMessagesCount || isRendering) {
                return;
            }

            isRendering = true;
            
            // ë²”ìš© ì¸ë””ì¼€ì´í„°ê°€ ìˆë‹¤ë©´ í•œ ë²ˆë§Œ ì œê±°í•©ë‹ˆë‹¤.
            showGeneralTypingIndicator(false);

            const newMessages = transcript.slice(displayedMessagesCount);
            
            for (const turn of newMessages) {
                // 1. ì´ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ì—ì´ì „íŠ¸ì˜ "ì…ë ¥ ì¤‘..." ì¸ë””ì¼€ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
                const indicator = showTypingIndicator(turn, participants);
                
                // 2. í˜„ì‹¤ê°ì„ ìœ„í•´ 1.5ì´ˆ ~ 2.5ì´ˆ ì‚¬ì´ì˜ ëœë¤í•œ ì‹œê°„ ë™ì•ˆ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
                await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));
                
                // 3. ì¸ë””ì¼€ì´í„°ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
                indicator.remove();

                // 4. ì‹¤ì œ ë©”ì‹œì§€ë¥¼ íƒ€ì´í•‘ íš¨ê³¼ì™€ í•¨ê»˜ ì¶”ê°€í•©ë‹ˆë‹¤.
                const messageContainer = appendMessage(turn, participants);
                const contentSpan = messageContainer.querySelector('.message-content');
                await typeMessage(contentSpan, turn.message);
                
                // 5. ë©”ì‹œì§€ ì¹´ìš´íŠ¸ë¥¼ ì¦ê°€ì‹œì¼œ ì¤‘ë³µ í‘œì‹œë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
                displayedMessagesCount++;
            }

            isRendering = false;
        }

        /**
         * 'ì…ë ¥ ì¤‘...' ì¸ë””ì¼€ì´í„°ë¥¼ ìƒì„±í•˜ê³  í™”ë©´ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
         */
        function showTypingIndicator(turn, participants) {
            const chatbox = document.getElementById('chatbox');
            const participantMap = getParticipantMap(participants);
            const agentName = turn.agent_name;
            const icon = participantMap[agentName]?.icon || 'ğŸ¤–';
            const isOdd = (displayedMessagesCount + 1) % 2 !== 0; // ë‹¤ìŒ ë©”ì‹œì§€ì˜ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ

            const indicator = document.createElement('div');
            if (isOdd) {
                indicator.className = 'flex gap-3 my-4 justify-end items-end';
                indicator.innerHTML = `
                    <div class="flex flex-col items-end">
                        <p class="text-sm font-bold text-slate-800">${agentName}</p>
                        <div class="bg-blue-500 text-white p-3 rounded-lg mt-1 inline-flex items-center gap-1">
                            <span class="typing-dot animate-bounce">.</span>
                            <span class="typing-dot animate-bounce" style="animation-delay: 0.2s">.</span>
                            <span class="typing-dot animate-bounce" style="animation-delay: 0.4s">.</span>
                        </div>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center text-xl">${icon}</div>`;
            } else {
                indicator.className = 'flex gap-3 my-4';
                indicator.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center text-xl">${icon}</div>
                    <div>
                        <p class="text-sm font-bold text-slate-800">${agentName}</p>
                        <div class="bg-slate-100 p-3 rounded-lg mt-1 inline-flex items-center gap-1">
                            <span class="typing-dot animate-bounce">.</span>
                            <span class="typing-dot animate-bounce" style="animation-delay: 0.2s">.</span>
                            <span class="typing-dot animate-bounce" style="animation-delay: 0.4s">.</span>
                        </div>
                    </div>`;
            }
            chatbox.appendChild(indicator);
            chatbox.scrollTop = chatbox.scrollHeight;
            return indicator;
        }

        /**
         * ë‹¨ì¼ ë©”ì‹œì§€ì˜ HTML êµ¬ì¡°ë¥¼ ë§Œë“¤ê³ , íƒ€ì´í•‘ íš¨ê³¼ë¥¼ ìœ„í•´ content spanì„ ë¹„ì›Œë‘ 
         */
        function appendMessage(turn, participants) {
            const chatbox = document.getElementById('chatbox');
            const participantMap = getParticipantMap(participants);
            const agentName = turn.agent_name;
            const icon = participantMap[agentName]?.icon || 'ğŸ¤–';
            const isOdd = displayedMessagesCount % 2 !== 0;

            const messageContainer = document.createElement('div');

            if (isOdd) {
                messageContainer.className = 'flex gap-3 my-4 justify-end items-end';
                messageContainer.innerHTML = `
                    <div class="flex flex-col items-end">
                        <p class="text-sm font-bold text-slate-800">${agentName}</p>
                        <div class="bg-blue-500 text-white p-3 rounded-lg mt-1 text-base inline-block max-w-xl text-left">
                            <span class="message-content"></span>
                        </div>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center text-xl">${icon}</div>`;
            } else {
                messageContainer.className = 'flex gap-3 my-4';
                messageContainer.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center text-xl">${icon}</div>
                    <div>
                        <p class="text-sm font-bold text-slate-800">${agentName}</p>
                        <div class="bg-slate-100 p-3 rounded-lg mt-1 text-base inline-block max-w-xl">
                            <span class="message-content"></span>
                        </div>
                    </div>`;
            }
            chatbox.appendChild(messageContainer);
            chatbox.scrollTop = chatbox.scrollHeight;
            return messageContainer;
        }

        /**
         * ê°„ë‹¨í•œ ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
         */
        function markdownToHtml(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\*(.*?)\*/g, '<em>$1</em>')       // Italic
                .replace(/^\s*\*\s(.*)/gm, '<ul><li>$1</li></ul>') // Basic lists
                .replace(/\n/g, '<br>'); // Line breaks
        }

        /**
         * ì°¸ê°€ì ì •ë³´ë¥¼ ë§µìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ëŠ” í—¬í¼ í•¨ìˆ˜
         */
        function getParticipantMap(participants) {
            const map = {};
            if (participants) {
                participants.forEach(p => {
                    map[p.name] = { icon: p.icon || 'ğŸ¤–' };
                });
            }
            return map;
        }

        /**
         * í…ìŠ¤íŠ¸ì— íƒ€ì´í•‘ íš¨ê³¼ë¥¼ ì ìš©í•˜ëŠ” í•¨ìˆ˜
         */
        function typeMessage(element, text) {
            return new Promise(resolve => {
                const htmlText = markdownToHtml(text);
                let i = 0;
                
                function typing() {
                    const chatbox = document.getElementById('chatbox');
                    if (i < htmlText.length) {
                        // '<'ë¥¼ ë§Œë‚˜ë©´ '>'ê°€ ë‚˜ì˜¬ ë•Œê¹Œì§€ í•œë²ˆì— ì¶”ê°€
                        if (htmlText.charAt(i) === '<') {
                            const closingTagIndex = htmlText.indexOf('>', i);
                            if (closingTagIndex !== -1) {
                                element.innerHTML += htmlText.substring(i, closingTagIndex + 1);
                                i = closingTagIndex;
                            }
                        } else {
                            element.innerHTML += htmlText.charAt(i);
                        }
                        i++;
                        chatbox.scrollTop = chatbox.scrollHeight;
                        setTimeout(typing, 20); // ë‹¤ìŒ ê¸€ì íƒ€ì´í•‘
                    } else {
                        resolve(); // íƒ€ì´í•‘ ì™„ë£Œ ì‹œ Promiseë¥¼ resolve
                    }
                }
                typing();
            });
        }

        /**
         * ì±„íŒ…ì°½ í•˜ë‹¨ì— ë²”ìš© "ì…ë ¥ ì¤‘..." ì¸ë””ì¼€ì´í„°ë¥¼ í‘œì‹œí•˜ê±°ë‚˜ ìˆ¨ê¸°ëŠ” í•¨ìˆ˜
         */
        function showGeneralTypingIndicator(show) {
            const chatbox = document.getElementById('chatbox');
            let indicator = document.getElementById('general-typing-indicator');

            if (show) {
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'general-typing-indicator';
                    indicator.className = 'flex gap-3 my-4';
                    indicator.innerHTML = `
                        <div class="w-10 h-10 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center text-xl">ğŸ¤–</div>
                        <div>
                            <p class="text-sm font-bold text-slate-800">AI Panel</p>
                            <div class="bg-slate-100 p-3 rounded-lg mt-1 inline-flex items-center gap-1">
                                <span class="typing-dot animate-bounce">.</span>
                                <span class="typing-dot animate-bounce" style="animation-delay: 0.2s">.</span>
                                <span class="typing-dot animate-bounce" style="animation-delay: 0.4s">.</span>
                            </div>
                        </div>`;
                    chatbox.appendChild(indicator);
                    chatbox.scrollTop = chatbox.scrollHeight;
                }
            } else {
                if (indicator) {
                    indicator.remove();
                }
            }
        }

        /**
         * íŠ¹ì • ì—ì´ì „íŠ¸ì˜ "ì…ë ¥ ì¤‘..." ì¸ë””ì¼€ì´í„°ë¥¼ ìƒì„±í•˜ê³  ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ (ìˆ˜ì •ëœ ë²„ì „)
         */
        function showTypingIndicator(turn, participants) {
            const chatbox = document.getElementById('chatbox');
            const participantMap = getParticipantMap(participants);
            const agentName = turn.agent_name;
            const icon = participantMap[agentName]?.icon || 'ğŸ¤–';
            const isOdd = (displayedMessagesCount) % 2 !== 0;

            const indicator = document.createElement('div');
            
            if (isOdd) {
                indicator.className = 'flex gap-3 my-4 justify-end items-end';
                indicator.innerHTML = `
                    <div class="flex flex-col items-end">
                        <p class="text-sm font-bold text-slate-800">${agentName}</p>
                        <div class="bg-blue-500 text-white p-3 rounded-lg mt-1 inline-flex items-center gap-1">
                            <span class="typing-dot animate-bounce">.</span>
                            <span class="typing-dot animate-bounce" style="animation-delay: 0.2s">.</span>
                            <span class="typing-dot animate-bounce" style="animation-delay: 0.4s">.</span>
                        </div>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center text-xl">${icon}</div>`;
            } else {
                indicator.className = 'flex gap-3 my-4';
                indicator.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center text-xl">${icon}</div>
                    <div>
                        <p class="text-sm font-bold text-slate-800">${agentName}</p>
                        <div class="bg-slate-100 p-3 rounded-lg mt-1 inline-flex items-center gap-1">
                            <span class="typing-dot animate-bounce">.</span>
                            <span class="typing-dot animate-bounce" style="animation-delay: 0.2s">.</span>
                            <span class="typing-dot animate-bounce" style="animation-delay: 0.4s">.</span>
                        </div>
                    </div>`;
            }
            chatbox.appendChild(indicator);
            chatbox.scrollTop = chatbox.scrollHeight;
            return indicator;
        }
        
        /**
         * ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ UIë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
         */
        function updateUIForLoggedInState() {
            const userEmail = localStorage.getItem('userEmail');
            if (userEmail) {
                userEmailDisplay.textContent = userEmail;
            }
        }
        
        /**
         * ë¡œê·¸ì•„ì›ƒ ìƒíƒœì— ë”°ë¼ UIë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
         */
        function updateUIForLoggedOutState() {
             userEmailDisplay.textContent = '';
             emailInput.value = 'user@example.com';
             passwordInput.value = 'userpassword';
        }

        // --- Event Listeners ---
        loginButton.addEventListener('click', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        startAnalysisButton.addEventListener('click', handleOrchestration);

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
                fileNameDisplay.classList.add('font-semibold', 'text-primary');
            } else {
                fileNameDisplay.textContent = 'ì°¸ê³  íŒŒì¼ ì²¨ë¶€ (TXT, PDF)';
                fileNameDisplay.classList.remove('font-semibold', 'text-primary');
            }
        });

        // --- Initial Check ---
        // í˜ì´ì§€ ë¡œë“œ ì‹œ, ì €ì¥ëœ í† í°ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì—¬ ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('accessToken');
            if (token) {
                console.log('ì €ì¥ëœ í† í°ìœ¼ë¡œ ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€');
                updateUIForLoggedInState();
                showScreen('screen-topic');
            } else {
                showScreen('screen-login');
            }
        });

    </script>
</body>
</html>
