<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMEET 관리자</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8fafc;
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: #4b5563;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .sidebar-link:hover {
            background-color: #e5e7eb;
            color: #111827;
        }
        .sidebar-link.active {
            background-color: #2563eb;
            color: white;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
        }
        .table th, .table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
        }
        .table tbody tr:hover {
            background-color: #f9fafb;
        }
        /* Toggle Switch CSS */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #2563eb;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #2563eb;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-md flex-shrink-0">
            <div class="p-4 border-b">
                <h1 class="text-2xl font-bold text-blue-600">AMEET Admin</h1>
            </div>
            <nav class="p-4 space-y-2">
                <a href="#" class="sidebar-link" onclick="showPage('dashboard')">
                    <span class="mr-3">📊</span> 대시보드
                </a>
                <a href="#" class="sidebar-link" onclick="showPage('users')">
                    <span class="mr-3">👥</span> 계정 관리
                </a>
                <a href="#" class="sidebar-link" onclick="showPage('monitoring')">
                    <span class="mr-3">🔍</span> 토론 모니터링
                </a>
                <a href="#" class="sidebar-link active" onclick="showPage('tokens')">
                    <span class="mr-3">💰</span> 토큰 사용량 분석
                </a>
                <a href="#" class="sidebar-link" onclick="showPage('agents')">
                    <span class="mr-3">🤖</span> 에이전트 설정
                </a>
            </nav>
            <div class="absolute bottom-0 w-64 p-4 border-t bg-white">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold">A</div>
                    <div class="ml-3">
                        <p class="font-semibold">관리자</p>
                        <a href="#" id="admin-logout-button" class="text-sm text-red-500">로그아웃</a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 md:p-8 overflow-y-auto">
            
            <!-- Page: Dashboard -->
            <div id="dashboard" class="page">
                <h2 class="text-3xl font-bold mb-6">대시보드</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="card text-center">
                        <p class="text-gray-500 text-sm">총 사용자</p>
                        <p class="text-4xl font-bold mt-2">128</p>
                    </div>
                    <div class="card text-center">
                        <p class="text-gray-500 text-sm">오늘 진행된 토론</p>
                        <p class="text-4xl font-bold mt-2">32</p>
                    </div>
                    <div class="card text-center">
                        <p class="text-gray-500 text-sm">총 에이전트 수</p>
                        <p class="text-4xl font-bold mt-2">35</p>
                    </div>
                    <div class="card text-center">
                        <p class="text-gray-500 text-sm">예상 월간 비용</p>
                        <p class="text-4xl font-bold mt-2">$256.70</p>
                    </div>
                </div>
                <div class="card">
                    <h3 class="font-bold mb-4">주간 토론 진행량</h3>
                    <div class="h-80"><canvas id="weeklyDiscussionsChart"></canvas></div>
                </div>
            </div>

            <!-- Page: User Management -->
            <div id="users" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">계정 관리</h2>
                    <button id="add-user-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">＋ 새 계정 추가</button>
                </div>
                <div class="card overflow-x-auto">
                    <table class="w-full table">
                        <thead>
                            <tr class="bg-gray-50">
                                <th>No.</th>
                                <th>이름</th>
                                <th>이메일</th>
                                <th>가입일</th>
                                <th>마지막 접속</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody id="user-list-tbody">
                            </tbody>
                    </table>
                </div>
            </div>

            <!-- Page: Discussion Monitoring -->
            <div id="monitoring" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">토론 이력 모니터링</h2>
                </div>
                <div class="card mb-6">
                    <div class="flex items-center gap-2">
                        <select id="monitoring-search-by" class="p-2 border-gray-300 border rounded-lg bg-white">
                            <option value="email" selected>사용자 이메일</option>
                            <option value="name">사용자 이름</option>
                        </select>
                        <input type="text" id="monitoring-search-term" placeholder="검색어 입력..." class="w-1/2 p-2 border-gray-300 border rounded-lg">
                        <button id="monitoring-search-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">검색</button>
                    </div>
                </div>
                <div class="card overflow-x-auto">
                    <table class="w-full table">
                        <thead>
                            <tr class="bg-gray-50">
                                <th>토론 ID</th>
                                <th>사용자 이메일</th>
                                <th>주제</th>
                                <th>시작 시간</th>
                                <th>상태</th>
                                <th>상세</th>
                            </tr>
                        </thead>
                        <tbody id="monitoring-list-tbody">
                            </tbody>
                    </table>
                </div>
            </div>

            <!-- Page: Token Usage Analysis (List View) -->
            <div id="tokens" class="page active">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">토큰 사용량 상세 분석</h2>
                    <a href="#" target="_blank" class="bg-gray-800 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-900">LangSmith에서 보기 ↗</a>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card text-center">
                        <p class="text-gray-500 text-sm">총 사용 비용 (이번 달)</p>
                        <p class="text-3xl font-bold mt-2">$182.50</p>
                    </div>
                    <div class="card text-center">
                        <p class="text-gray-500 text-sm">총 토론 수</p>
                        <p class="text-3xl font-bold mt-2">482</p>
                    </div>
                    <div class="card text-center">
                        <p class="text-gray-500 text-sm">토론 당 평균 비용</p>
                        <p class="text-3xl font-bold mt-2">$0.378</p>
                    </div>
                </div>

                <div class="card mb-8">
                    <h3 class="font-bold mb-4">토론별 비용 분석</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full table">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th>토론 ID</th>
                                    <th>사용자</th>
                                    <th>총 토큰</th>
                                    <th>예상 비용</th>
                                    <th>모델별 사용량</th>
                                    <th>상세</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>sess_abc123</td>
                                    <td>user1@...</td>
                                    <td>15,820</td>
                                    <td>$0.45</td>
                                    <td>
                                        <div class="text-xs">
                                            <p><strong>GPT-4o:</strong> 8,120</p>
                                            <p><strong>Gemini:</strong> 5,200</p>
                                            <p><strong>Claude:</strong> 2,500</p>
                                        </div>
                                    </td>
                                    <td><a href="#" class="text-blue-500 font-semibold" onclick="showDetailPage('sess_abc123')">분석</a></td>
                                </tr>
                                 <tr>
                                    <td>sess_ghi789</td>
                                    <td>user3@...</td>
                                    <td>8,550</td>
                                    <td>$0.21</td>
                                    <td>
                                        <div class="text-xs">
                                            <p><strong>GPT-4o:</strong> 3,500</p>
                                            <p><strong>Gemini:</strong> 5,050</p>
                                        </div>
                                    </td>
                                    <td><a href="#" class="text-blue-500 font-semibold" onclick="showDetailPage('sess_ghi789')">분석</a></td>
                                </tr>
                                <tr>
                                    <td>sess_jkl012</td>
                                    <td>user1@...</td>
                                    <td>22,100</td>
                                    <td>$0.88</td>
                                    <td>
                                        <div class="text-xs">
                                            <p><strong>Claude:</strong> 22,100</p>
                                        </div>
                                    </td>
                                    <td><a href="#" class="text-blue-500 font-semibold" onclick="showDetailPage('sess_jkl012')">분석</a></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="font-bold mb-4">모델별 총 비용 분석</h3>
                        <div class="h-80"><canvas id="costByModelChart"></canvas></div>
                    </div>
                    <div class="card">
                        <h3 class="font-bold mb-4">일별 토론 비용 추이</h3>
                        <div class="h-80"><canvas id="dailyCostChart"></canvas></div>
                    </div>
                </div>
            </div>
            
            <!-- [NEW] Page: Token Usage Detail View -->
            <div id="token-detail" class="page">
                <div class="mb-6">
                    <button class="text-blue-600 font-semibold hover:underline" onclick="showPage('tokens')">← 토큰 분석 목록으로 돌아가기</button>
                </div>
                <h2 class="text-3xl font-bold mb-2">토론 상세 분석: <span id="detail-session-id" class="text-blue-600"></span></h2>
                <p class="text-gray-500 mb-6" id="detail-topic"></p>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="card text-center"><p class="text-gray-500 text-sm">총 비용</p><p id="detail-total-cost" class="text-3xl font-bold mt-2"></p></div>
                    <div class="card text-center"><p class="text-gray-500 text-sm">총 토큰</p><p id="detail-total-tokens" class="text-3xl font-bold mt-2"></p></div>
                    <div class="card text-center"><p class="text-gray-500 text-sm">사용자</p><p id="detail-user" class="text-xl font-bold mt-2"></p></div>
                    <div class="card text-center"><p class="text-gray-500 text-sm">토론 시간</p><p id="detail-duration" class="text-3xl font-bold mt-2"></p></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 card">
                        <h3 class="font-bold mb-4">에이전트별 비용 상세 내역</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full table">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th>순서</th>
                                        <th>에이전트</th>
                                        <th>모델</th>
                                        <th>입력 토큰</th>
                                        <th>출력 토큰</th>
                                        <th>비용</th>
                                    </tr>
                                </thead>
                                <tbody id="detail-turn-table">
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="font-bold mb-4">에이전트별 비용 기여도</h3>
                        <div class="h-80"><canvas id="costByAgentChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Page: Agent Settings -->
            <div id="agents" class="page active">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">에이전트 설정</h2>
                    <button class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700" onclick="toggleModal('agent-edit-modal')">＋ 새 에이전트 추가</button>
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <!-- [제안 4 반영] 활성화/비활성화 토글 추가 -->
                    <div class="card text-center relative">
                        <div class="absolute top-4 right-4 flex items-center gap-2">
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="toggle1" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                                <label for="toggle1" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                            <button onclick="toggleModal('agent-edit-modal')">⚙️</button>
                        </div>
                        <p class="text-5xl pt-4">💹</p>
                        <h3 class="font-bold mt-2">재무 분석가</h3>
                        <p class="text-xs text-gray-500 mt-1">gemini-1.5-pro</p>
                    </div>
                    <div class="card text-center relative opacity-50 bg-gray-50">
                         <div class="absolute top-4 right-4 flex items-center gap-2">
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="toggle2" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="toggle2" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                            <button onclick="toggleModal('agent-edit-modal')">⚙️</button>
                        </div>
                        <p class="text-5xl pt-4">🤔</p>
                        <h3 class="font-bold mt-2">비판적 관점 (비활성)</h3>
                        <p class="text-xs text-gray-500 mt-1">gpt-4o</p>
                    </div>
                     <div class="card text-center relative">
                        <div class="absolute top-4 right-4 flex items-center gap-2">
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="toggle3" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                                <label for="toggle3" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                            <button onclick="toggleModal('agent-edit-modal')">⚙️</button>
                        </div>
                        <p class="text-5xl pt-4">🌍</p>
                        <h3 class="font-bold mt-2">거시경제 전문가</h3>
                        <p class="text-xs text-gray-500 mt-1">claude-3.5-sonnet</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 사용자 추가 -->
    <div id="user-add-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="card w-full max-w-lg max-h-[90vh] flex flex-col p-0">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold text-blue-600">새 계정 추가</h2>
                <button class="text-2xl font-bold" onclick="toggleModal('user-add-modal')">&times;</button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <div>
                    <label class="font-semibold">이름</label>
                    <input type="text" id="new-user-name" placeholder="홍길동" class="w-full mt-1 p-2 border-gray-300 border rounded-lg">
                </div>
                <div>
                    <label class="font-semibold">이메일</label>
                    <input type="email" id="new-user-email" placeholder="user@example.com" class="w-full mt-1 p-2 border-gray-300 border rounded-lg">
                </div>
                <div>
                    <label class="font-semibold">비밀번호</label>
                    <input type="password" id="new-user-password" placeholder="비밀번호 입력" class="w-full mt-1 p-2 border-gray-300 border rounded-lg">
                </div>
                <div>
                    <label class="font-semibold">역할</label>
                    <select id="new-user-role" class="w-full mt-1 p-2 border-gray-300 border rounded-lg bg-white">
                        <option value="user" selected>user</option>
                        <option value="admin">admin</option>
                    </select>
                </div>
                <div id="user-add-error" class="text-sm text-red-500 h-4"></div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end items-center gap-4">
                <button class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300" onclick="toggleModal('user-add-modal')">취소</button>
                <button id="save-user-button" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">저장</button>
            </div>
        </div>
    </div>

    <!-- 사용자 수정 -->
    <div id="user-edit-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="card w-full max-w-lg max-h-[90vh] flex flex-col p-0">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold text-blue-600">계정 정보 수정</h2>
                <button class="text-2xl font-bold" onclick="toggleModal('user-edit-modal')">&times;</button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="edit-user-id">
                <div>
                    <label class="font-semibold">이름</label>
                    <input type="text" id="edit-user-name" class="w-full mt-1 p-2 border-gray-300 border rounded-lg">
                </div>
                <div>
                    <label class="font-semibold">이메일 (수정 불가)</label>
                    <input type="email" id="edit-user-email" class="w-full mt-1 p-2 border-gray-300 border rounded-lg bg-gray-100" readonly>
                </div>
                <div>
                    <label class="font-semibold">새 비밀번호</label>
                    <input type="password" id="edit-user-password" placeholder="변경할 경우에만 입력하세요" class="w-full mt-1 p-2 border-gray-300 border rounded-lg">
                </div>
                <div>
                    <label class="font-semibold">역할</label>
                    <select id="edit-user-role" class="w-full mt-1 p-2 border-gray-300 border rounded-lg bg-white">
                        <option value="user">user</option>
                        <option value="admin">admin</option>
                    </select>
                </div>
                <div id="user-edit-error" class="text-sm text-red-500 h-4"></div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end items-center gap-4">
                <button class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300" onclick="toggleModal('user-edit-modal')">취소</button>
                <button id="save-edit-user-button" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">수정사항 저장</button>
            </div>
        </div>
    </div>

    <!-- [NEW] 에이전트 수정/추가 Modal -->
    <div id="agent-edit-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="card w-full max-w-2xl max-h-[90vh] flex flex-col p-0">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold text-blue-600">에이전트 설정 수정</h2>
                <button class="text-2xl font-bold" onclick="toggleModal('agent-edit-modal')">&times;</button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <div>
                    <label class="font-semibold">에이전트 이름</label>
                    <input type="text" value="재무 분석가" class="w-full mt-1 p-2 border-gray-300 border rounded-lg">
                </div>
                <div>
                    <label class="font-semibold">시스템 프롬프트</label>
                    <textarea rows="8" class="w-full mt-1 p-2 border-gray-300 border rounded-lg">You are a professional Financial Analyst...</textarea>
                </div>
                <div>
                    <label class="font-semibold">LLM 모델</label>
                    <select class="w-full mt-1 p-2 border-gray-300 border rounded-lg">
                        <option>gpt-4o</option>
                        <option selected>gemini-1.5-pro</option>
                        <option>claude-3.5-sonnet</option>
                    </select>
                </div>
                <!-- [제안 4 반영] 변경 이력 확인 버튼 -->
                <button class="text-sm text-blue-600 hover:underline" onclick="toggleModal('history-modal')">프롬프트 변경 이력 보기</button>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end items-center gap-4">
                <button class="text-red-600 font-semibold hover:text-red-800">삭제</button>
                <button class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300" onclick="toggleModal('agent-edit-modal')">취소</button>
                <button class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">저장</button>
            </div>
        </div>
    </div>

    <!-- [NEW] 프롬프트 변경 이력 Modal -->
    <div id="history-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="card w-full max-w-lg max-h-[70vh] flex flex-col p-0">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold text-blue-600">프롬프트 변경 이력</h2>
                <button class="text-2xl font-bold" onclick="toggleModal('history-modal')">&times;</button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <div class="border-b pb-2">
                    <p class="font-semibold">버전 1.2 <span class="text-sm text-gray-500 font-normal">(2025-08-20 by admin)</span></p>
                    <p class="text-sm text-gray-600 mt-1">"You are a professional Financial Analyst. Your role is to provide insightful financial analysis..."</p>
                </div>
                 <div class="border-b pb-2">
                    <p class="font-semibold">버전 1.1 <span class="text-sm text-gray-500 font-normal">(2025-08-15 by admin)</span></p>
                    <p class="text-sm text-gray-600 mt-1">"You are a Financial Analyst..."</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수로 사용자 목록 데이터 저장
        let currentUsers = [];

        // Mock Data for Detail Page
        const detailData = {
            "sess_abc123": {
                topic: "테슬라 주가 전망에 대한 심층 분석",
                total_cost: 0.45,
                total_tokens: 15820,
                user: "user1@example.com",
                duration: "12분 30초",
                turns: [
                    { turn: 1, agent: "SNS 트렌드 분석가", model: "Gemini 1.5", input: 500, output: 1200, cost: 0.05 },
                    { turn: 2, agent: "재무 분석가", model: "GPT-4o", input: 1500, output: 800, cost: 0.10 },
                    { turn: 3, agent: "비판적 관점", model: "Claude 3.5", input: 1300, output: 1200, cost: 0.08 },
                    { turn: 4, agent: "거시경제 전문가", model: "Gemini 1.5", input: 1800, output: 1700, cost: 0.12 },
                    { turn: 5, agent: "재무 분석가", model: "GPT-4o", input: 2120, output: 1500, cost: 0.10 },
                ]
            }
        };

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
            document.querySelector(`.sidebar-link[onclick="showPage('${pageId}')"]`).classList.add('active');

            // '계정 관리' 페이지가 보일 때 사용자 목록을 불러오도록 함
            if (pageId === 'users') {
                loadUsers();
            }

            // 'monitoring' 페이지가 보일 때 토론 목록을 불러오도록 추가
            if (pageId === 'monitoring') {
                loadDiscussions();
            }
        }

        function toggleModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
            } else {
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        let costByAgentChartInstance;
        function showDetailPage(sessionId) {
            const data = detailData[sessionId] || detailData["sess_abc123"]; // Fallback for demo

            // Populate summary
            document.getElementById('detail-session-id').textContent = sessionId;
            document.getElementById('detail-topic').textContent = `주제: ${data.topic}`;
            document.getElementById('detail-total-cost').textContent = `$${data.total_cost.toFixed(2)}`;
            document.getElementById('detail-total-tokens').textContent = data.total_tokens.toLocaleString();
            document.getElementById('detail-user').textContent = data.user;
            document.getElementById('detail-duration').textContent = data.duration;

            // Populate turn-by-turn table
            const tableBody = document.getElementById('detail-turn-table');
            tableBody.innerHTML = '';
            data.turns.forEach(turn => {
                const row = `
                    <tr>
                        <td>${turn.turn}</td>
                        <td>${turn.agent}</td>
                        <td><span class="bg-gray-100 text-gray-800 text-xs font-medium px-2 py-0.5 rounded">${turn.model}</span></td>
                        <td>${turn.input.toLocaleString()}</td>
                        <td>${turn.output.toLocaleString()}</td>
                        <td>$${turn.cost.toFixed(3)}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Aggregate data for chart
            const agentCosts = data.turns.reduce((acc, turn) => {
                acc[turn.agent] = (acc[turn.agent] || 0) + turn.cost;
                return acc;
            }, {});

            const chartLabels = Object.keys(agentCosts);
            const chartData = Object.values(agentCosts);

            // Create or update agent cost chart
            const ctxCostAgent = document.getElementById('costByAgentChart').getContext('2d');
            if (costByAgentChartInstance) {
                costByAgentChartInstance.destroy();
            }
            costByAgentChartInstance = new Chart(ctxCostAgent, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: '비용 기여도 ($)',
                        data: chartData,
                        backgroundColor: ['#2563eb', '#34d399', '#f59e0b', '#ef4444', '#8b5cf6']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            showPage('token-detail');
        }

        /**
         * API에서 사용자 목록을 가져와 테이블을 렌더링하는 함수
         */
        async function loadUsers() {
            const token = localStorage.getItem('accessToken');
            if (!token) return;

            const tbody = document.getElementById('user-list-tbody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">사용자 목록을 불러오는 중...</td></tr>';

            try {
                const response = await fetch('/api/v1/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`[${response.status}] 사용자 목록을 가져오는데 실패했습니다.`);
                }

                const users = await response.json();
                tbody.innerHTML = ''; // 기존 내용 삭제

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">표시할 사용자가 없습니다.</td></tr>';
                    return;
                }

                // 서버에서 이미 최신순으로 정렬해서 보내주므로 바로 사용
                users.forEach((user, index) => {
                    const row = document.createElement('tr');
                    // 모든 user.id를 user._id로 참조
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${formatDateTime(user.created_at)}</td>
                        <td>${formatDateTime(user.last_login_at)}</td>
                        <td>
                            <button class="text-blue-500 text-sm font-semibold edit-btn" data-userid="${user._id}">수정</button> 
                            <button class="text-red-500 text-sm font-semibold ml-2 delete-btn" data-userid="${user._id}" data-username="${user.name}">삭제</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                window.currentUsers = users;

            } catch (error) {
                console.error('Error loading users:', error);
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-red-500 py-4">${error.message}</td></tr>`;
            }
        }

        /**
         * '저장' 버튼 클릭 시 새 사용자 정보를 서버에 POST 요청하는 함수
         */
        async function handleAddNewUser() {
            const nameInput = document.getElementById('new-user-name');
            const emailInput = document.getElementById('new-user-email');
            const passwordInput = document.getElementById('new-user-password');
            const roleInput = document.getElementById('new-user-role');
            const errorDiv = document.getElementById('user-add-error');
            const saveButton = document.getElementById('save-user-button');

            const newUser = {
                name: nameInput.value.trim(),
                email: emailInput.value.trim(),
                password: passwordInput.value,
                role: roleInput.value
            };

            // 간단한 유효성 검사
            if (!newUser.name || !newUser.email || !newUser.password) {
                errorDiv.textContent = '이름, 이메일, 비밀번호는 필수 항목입니다.';
                return;
            }
            errorDiv.textContent = '';
            saveButton.disabled = true;
            saveButton.textContent = '저장 중...';

            const token = localStorage.getItem('accessToken');

            try {
                const response = await fetch('/api/v1/users/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newUser)
                });

                if (response.status === 201) { // 201 Created
                    alert('새로운 사용자가 성공적으로 추가되었습니다.');
                    toggleModal('user-add-modal');
                    await loadUsers(); // 사용자 목록 새로고침
                } else {
                    const errorData = await response.json();
                    errorDiv.textContent = errorData.detail || '사용자 추가에 실패했습니다.';
                }
            } catch (error) {
                console.error('Error adding new user:', error);
                errorDiv.textContent = '서버 통신 중 오류가 발생했습니다.';
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = '저장';
            }
        }

        /**
         * 수정 버튼 클릭 시 모달을 열고 기존 정보를 채우는 함수
         */
        function openEditModal(userId) {
            const user = window.currentUsers.find(u => u._id === userId);
            if (!user) {
                alert('사용자 정보를 찾을 수 없습니다.');
                return;
            }

            document.getElementById('edit-user-id').value = user._id;
            document.getElementById('edit-user-name').value = user.name;
            document.getElementById('edit-user-email').value = user.email;
            document.getElementById('edit-user-role').value = user.role;
            document.getElementById('edit-user-password').value = '';
            document.getElementById('user-edit-error').textContent = '';

            toggleModal('user-edit-modal');
        }

        /**
         * 수정된 사용자 정보를 서버에 PUT 요청하는 함수
         */
        async function handleUpdateUser() {
            const userId = document.getElementById('edit-user-id').value;
            const name = document.getElementById('edit-user-name').value.trim();
            const password = document.getElementById('edit-user-password').value;
            const role = document.getElementById('edit-user-role').value;
            const errorDiv = document.getElementById('user-edit-error');
            const saveButton = document.getElementById('save-edit-user-button');

            const updatePayload = { name, role };
            // 비밀번호 필드가 비어있지 않은 경우에만 payload에 추가
            if (password) {
                updatePayload.password = password;
            }

            saveButton.disabled = true;
            saveButton.textContent = '저장 중...';
            errorDiv.textContent = '';
            const token = localStorage.getItem('accessToken');

            try {
                const response = await fetch(`/api/v1/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatePayload)
                });

                if (response.ok) {
                    alert('사용자 정보가 성공적으로 수정되었습니다.');
                    toggleModal('user-edit-modal');
                    await loadUsers(); // 목록 새로고침
                } else {
                    const errorData = await response.json();
                    errorDiv.textContent = errorData.detail || '수정에 실패했습니다.';
                }
            } catch (error) {
                errorDiv.textContent = '서버 통신 중 오류가 발생했습니다.';
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = '수정사항 저장';
            }
        }

        /**
         * 삭제 버튼 클릭 시 확인 후 서버에 DELETE 요청하는 함수
         */
        async function handleDeleteUser(userId, userName) {
            if (!confirm(`정말로 '${userName}' 사용자를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`)) {
                return;
            }
            
            const token = localStorage.getItem('accessToken');

            try {
                const response = await fetch(`/api/v1/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert(`'${userName}' 사용자가 삭제되었습니다.`);
                    await loadUsers(); // 목록 새로고침
                } else {
                    const errorData = await response.json();
                    alert(`삭제 실패: ${errorData.detail}`);
                }
            } catch (error) {
                alert('서버 통신 중 오류가 발생했습니다.');
            }
        }

        /**
         * 날짜 문자열을 'YYYY-MM-DD HH:MM:SS' 형식으로 변환합니다.
         * @param {string | null} dateString - 변환할 날짜 문자열
         * @returns {string} - 포맷된 날짜 또는 'N/A'
        
         * 날짜 문자열을 한국 시간(KST)으로 변환합니다.
         * 서버에서 받은 UTC 시간 객체에 직접 9시간을 더해 KST로 만듭니다.
         * @param {string | null} dateString - 변환할 날짜 문자열 (예: '2025-09-18T05:54:57.765+00:00')
         * @returns {string} - 'YYYY-MM-DD HH:MM:SS' 형식의 KST 날짜
         */
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            try {
                // 1. 서버에서 받은 시간 문자열로 Date 객체를 생성합니다.
                //    이 객체는 내부적으로 UTC 시간 정보를 가집니다.
                const date = new Date(dateString);

                if (isNaN(date.getTime())) return 'Invalid Date';

                // 2. [핵심] UTC 시간에 9시간을 직접 더하여 한국 시간(KST)으로 만듭니다.
                date.setHours(date.getHours() + 9);

                // 3. 9시간이 더해진 시간을 원하는 형식으로 조합합니다.
                //    getUTCFullYear(), getUTCMonth() 등을 사용하여 UTC 기준의 날짜/시간을 추출해야
                //    브라우저의 자체적인 시간대 변환을 막을 수 있습니다.
                const year = date.getUTCFullYear();
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const day = String(date.getUTCDate()).padStart(2, '0');
                const hours = String(date.getUTCHours()).padStart(2, '0');
                const minutes = String(date.getUTCMinutes()).padStart(2, '0');
                const seconds = String(date.getUTCSeconds()).padStart(2, '0');

                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            } catch (e) {
                return dateString; // 파싱 실패 시 원본 반환
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            
            showPage('agents'); // Default page

            // Chart instances
            let weeklyChart, costModelChart, dailyCostChart;

            // Weekly Discussions Chart
            const ctxWeekly = document.getElementById('weeklyDiscussionsChart')?.getContext('2d');
            if(ctxWeekly) {
                weeklyChart = new Chart(ctxWeekly, {
                    type: 'line',
                    data: {
                        labels: ['월', '화', '수', '목', '금', '토', '일'],
                        datasets: [{
                            label: '토론 수',
                            data: [12, 19, 25, 28, 32, 22, 18],
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            // Cost by Model Chart
            const ctxCostModel = document.getElementById('costByModelChart')?.getContext('2d');
            if(ctxCostModel) {
                costModelChart = new Chart(ctxCostModel, {
                    type: 'pie',
                    data: {
                        labels: ['GPT-4o', 'Gemini 1.5 Pro', 'Claude 3.5 Sonnet'],
                        datasets: [{
                            label: '비용 ($)',
                            data: [95.40, 55.20, 31.90],
                            backgroundColor: ['#2563eb', '#34d399', '#f59e0b']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            // Daily Cost Chart
            const ctxDailyCost = document.getElementById('dailyCostChart')?.getContext('2d');
            if(ctxDailyCost) {
                dailyCostChart = new Chart(ctxDailyCost, {
                    type: 'bar',
                    data: {
                        labels: ['8/12', '8/13', '8/14', '8/15', '8/16', '8/17', '8/18'],
                        datasets: [{
                            label: '일별 비용 ($)',
                            data: [15.2, 22.5, 28.1, 30.5, 35.8, 25.4, 25.0],
                            backgroundColor: '#60a5fa'
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                    }
                });
            }

            // 토론 모니터링 검색 버튼 이벤트 리스너 추가
            const searchBtn = document.getElementById('monitoring-search-btn');
            if (searchBtn) {
                searchBtn.addEventListener('click', loadDiscussions);
            }

            // 이메일 필터에서 Enter 키를 눌렀을 때 검색 실행
            const searchTermInput = document.getElementById('monitoring-search-term');
            if (searchTermInput) {
                searchTermInput.addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') {
                        loadDiscussions();
                    }
                });
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            
            const logoutButton = document.getElementById('admin-logout-button');
            const accessToken = localStorage.getItem('accessToken');

            // 새 계정 추가 기능 이벤트 리스너
            const addUserButton = document.getElementById('add-user-button');
            const saveUserButton = document.getElementById('save-user-button');

            if (addUserButton) {
                addUserButton.addEventListener('click', () => {
                    // 모달을 열기 전, 입력 필드와 에러 메시지를 깨끗하게 초기화합니다.
                    document.getElementById('new-user-name').value = '';
                    document.getElementById('new-user-email').value = '';
                    document.getElementById('new-user-password').value = '';
                    document.getElementById('new-user-role').value = 'user';
                    document.getElementById('user-add-error').textContent = '';
                    toggleModal('user-add-modal');
                });
            }

            if (saveUserButton) {
                saveUserButton.addEventListener('click', handleAddNewUser);
            }

            // --- 사용자 목록의 수정/삭제 버튼 이벤트 처리 (이벤트 위임) ---
            const userListBody = document.getElementById('user-list-tbody');
            if (userListBody) {
                userListBody.addEventListener('click', (event) => {
                    const target = event.target;
                    if (target.classList.contains('edit-btn')) {
                        const userId = target.dataset.userid;
                        openEditModal(userId);
                    }
                    if (target.classList.contains('delete-btn')) {
                        const userId = target.dataset.userid;
                        const userName = target.dataset.username;
                        handleDeleteUser(userId, userName);
                    }
                });
            }

            // --- [추가] 수정 모달의 저장 버튼 이벤트 리스너 ---
            const saveEditButton = document.getElementById('save-edit-user-button');
            if (saveEditButton) {
                saveEditButton.addEventListener('click', handleUpdateUser);
            }

            // 1. 페이지 로드 시, 토큰이 없으면 로그인 페이지로 즉시 이동
            if (!accessToken) {
                console.log('액세스 토큰이 없어 로그인 페이지로 이동합니다.');
                window.location.href = '/';
                return;
            }

            // 2. 로그아웃 버튼에 클릭 이벤트 리스너 추가
            if (logoutButton) {
                logoutButton.addEventListener('click', (event) => {
                    event.preventDefault(); // a 태그의 기본 동작 방지

                    // 3. 로컬 스토리지에서 사용자 정보 삭제
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('userEmail');

                    console.log('관리자 계정이 로그아웃되었습니다.');

                    // 4. 메인 로그인 페이지로 리디렉션
                    window.location.href = '/';
                });
            }
        });

        /**
         * 토론 상태에 따라 적절한 스타일의 뱃지 HTML을 반환합니다.
         * @param {string} status - 토론 상태 문자열
         * @returns {string} - 뱃지 HTML
         */
        function renderStatusBadge(status) {
            const statusMap = {
                'completed': { text: '완료', class: 'bg-green-100 text-green-800' },
                'report_generating': { text: '보고서 생성중', class: 'bg-blue-100 text-blue-800' },
                'waiting_for_vote': { text: '진행중', class: 'bg-yellow-100 text-yellow-800' },
                'turn_inprogress': { text: '진행중', class: 'bg-yellow-100 text-yellow-800' },
                'failed': { text: '실패', class: 'bg-red-100 text-red-800' },
                'orchestrating': { text: '팀 구성중', class: 'bg-indigo-100 text-indigo-800' },
                'ready': { text: '시작 대기중', class: 'bg-gray-100 text-gray-800' }
            };
            const statusInfo = statusMap[status] || { text: status, class: 'bg-gray-100 text-gray-800' };
            return `<span class="${statusInfo.class} text-xs font-medium px-2.5 py-0.5 rounded-full">${statusInfo.text}</span>`;
        }

        /**
         * API에서 토론 이력 목록을 가져와 테이블을 렌더링하는 함수
         */
        async function loadDiscussions() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                window.location.href = '/';
                return;
            }

            const tbody = document.getElementById('monitoring-list-tbody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">토론 목록을 불러오는 중...</td></tr>';

            // 1. 새로운 UI 요소에서 값을 읽어옵니다.
            const searchBy = document.getElementById('monitoring-search-by').value;
            const searchTerm = document.getElementById('monitoring-search-term').value.trim();
            
            let apiUrl = '/api/v1/admin/discussions';
            
            // 2. 검색어가 있을 경우에만 쿼리 파라미터를 추가합니다.
            if (searchTerm) {
                apiUrl += `?search_by=${searchBy}&search_term=${encodeURIComponent(searchTerm)}`;
            }

            try {
                const response = await fetch(apiUrl, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // ... (이하 로직은 동일)
                if (!response.ok) {
                    throw new Error(`[${response.status}] 토론 목록을 가져오는데 실패했습니다.`);
                }

                const discussions = await response.json();
                tbody.innerHTML = ''; 

                if (discussions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">표시할 토론이 없습니다.</td></tr>';
                    return;
                }

                discussions.forEach(discussion => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="font-mono text-sm">${discussion.discussion_id}</td>
                        <td>${discussion.user_email}</td>
                        <td class="max-w-xs truncate">${discussion.topic}</td>
                        <td>${formatDateTime(discussion.created_at)}</td>
                        <td>${renderStatusBadge(discussion.status)}</td>
                        <td><a href="#" class="text-blue-500 font-semibold" onclick="showDiscussionDetail('${discussion.discussion_id}')">상세 보기</a></td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading discussions:', error);
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-red-500 py-4">${error.message}</td></tr>`;
            }
        }

        // 상세 보기 기능은 아직 구현되지 않았으므로 alert으로 대체합니다.
        function showDiscussionDetail(discussionId) {
            alert(`'${discussionId}' 토론의 상세 내역을 표시하는 기능은 아직 구현되지 않았습니다.`);
        }
    </script>
</body>
</html>
