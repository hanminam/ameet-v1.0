<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMEET ê´€ë¦¬ì</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8fafc;
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: #4b5563;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .sidebar-link:hover {
            background-color: #e5e7eb;
            color: #111827;
        }
        .sidebar-link.active {
            background-color: #2563eb;
            color: white;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
        }
        .table th, .table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
        }
        .table tbody tr:hover {
            background-color: #f9fafb;
        }
        /* Toggle Switch CSS */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #2563eb;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #2563eb;
        }
        /* íƒ­ ê´€ë ¨ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .tab-link {
            cursor: pointer;
            border-bottom-width: 2px;
            padding: 1rem 0.25rem;
            font-weight: 500;
            color: #6b7280; /* gray-500 */
            border-color: transparent;
        }
        .tab-link:hover {
            border-color: #d1d5db; /* gray-300 */
            color: #4b5563; /* gray-600 */
        }
        .tab-link.active {
            border-color: #2563eb; /* blue-600 */
            color: #2563eb;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-md flex-shrink-0">
            <div class="p-4 border-b">
                <h1 class="text-2xl font-bold text-blue-600">AMEET Admin</h1>
            </div>
            <nav class="p-4 space-y-2">
                <a href="#" class="sidebar-link" onclick="showPage('dashboard')">
                    <span class="mr-3">ğŸ“Š</span> ëŒ€ì‹œë³´ë“œ
                </a>
                <a href="#" class="sidebar-link" onclick="showPage('users')">
                    <span class="mr-3">ğŸ‘¥</span> ê³„ì • ê´€ë¦¬
                </a>
                <a href="#" class="sidebar-link" onclick="showPage('monitoring')">
                    <span class="mr-3">ğŸ”</span> í† ë¡  ëª¨ë‹ˆí„°ë§
                </a>
                <a href="#" class="sidebar-link active" onclick="showPage('tokens')">
                    <span class="mr-3">ğŸ’°</span> í† í° ì‚¬ìš©ëŸ‰ ë¶„ì„
                </a>
                <a href="#" class="sidebar-link" onclick="showPage('agents')">
                    <span class="mr-3">ğŸ¤–</span> ì—ì´ì „íŠ¸ ì„¤ì •
                </a>
            </nav>
            <div class="absolute bottom-0 w-64 p-4 border-t bg-white">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold">A</div>
                    <div class="ml-3">
                        <p class="font-semibold">ê´€ë¦¬ì</p>
                        <a href="#" id="admin-logout-button" class="text-sm text-red-500">ë¡œê·¸ì•„ì›ƒ</a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 md:p-8 overflow-y-auto">
            
            <!-- Page: Dashboard -->
            <div id="dashboard" class="page">
                <h2 class="text-3xl font-bold mb-6">ëŒ€ì‹œë³´ë“œ</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="card text-center">
                        <p class="text-gray-500 text-sm">ì´ ì‚¬ìš©ì</p>
                        <p class="text-4xl font-bold mt-2">128</p>
                    </div>
                    <div class="card text-center">
                        <p class="text-gray-500 text-sm">ì˜¤ëŠ˜ ì§„í–‰ëœ í† ë¡ </p>
                        <p class="text-4xl font-bold mt-2">32</p>
                    </div>
                    <div class="card text-center">
                        <p class="text-gray-500 text-sm">ì´ ì—ì´ì „íŠ¸ ìˆ˜</p>
                        <p class="text-4xl font-bold mt-2">35</p>
                    </div>
                    <div class="card text-center">
                        <p class="text-gray-500 text-sm">ì˜ˆìƒ ì›”ê°„ ë¹„ìš©</p>
                        <p class="text-4xl font-bold mt-2">$256.70</p>
                    </div>
                </div>
                <div class="card">
                    <h3 class="font-bold mb-4">ì£¼ê°„ í† ë¡  ì§„í–‰ëŸ‰</h3>
                    <div class="h-80"><canvas id="weeklyDiscussionsChart"></canvas></div>
                </div>
            </div>

            <!-- Page: User Management -->
            <div id="users" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">ê³„ì • ê´€ë¦¬</h2>
                    <button id="add-user-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">ï¼‹ ìƒˆ ê³„ì • ì¶”ê°€</button>
                </div>
                <div class="card overflow-x-auto">
                    <table class="w-full table">
                        <thead>
                            <tr class="bg-gray-50">
                                <th>No.</th>
                                <th>ì´ë¦„</th>
                                <th>ì´ë©”ì¼</th>
                                <th>ê°€ì…ì¼</th>
                                <th>ë§ˆì§€ë§‰ ì ‘ì†</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="user-list-tbody">
                            </tbody>
                    </table>
                </div>
            </div>

            <!-- Page: Discussion Monitoring -->
            <div id="monitoring" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">í† ë¡  ì´ë ¥ ëª¨ë‹ˆí„°ë§</h2>
                </div>
                <div class="card mb-6">
                    <div class="flex items-center gap-2">
                        <select id="monitoring-search-by" class="p-2 border-gray-300 border rounded-lg bg-white">
                            <option value="name" selected>ì‚¬ìš©ì ì´ë¦„</option>
                            <option value="email">ì‚¬ìš©ì ì´ë©”ì¼</option>
                        </select>
                        <input type="text" id="monitoring-search-term" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." class="w-1/2 p-2 border-gray-300 border rounded-lg">
                        <button id="monitoring-search-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">ê²€ìƒ‰</button>
                    </div>
                </div>
                <div class="card overflow-x-auto">
                    <table class="w-full table">
                        <thead>
                            <tr class="bg-gray-50">
                                <th>í† ë¡  ID</th>
                                <th>ì‚¬ìš©ìëª…</th> 
                                <th>ì‚¬ìš©ì ì´ë©”ì¼</th>
                                <th>ì£¼ì œ</th>
                                <th>ì‹œì‘ ì‹œê°„</th>
                                <th>ìƒíƒœ</th>
                                <th>ìƒì„¸</th>
                            </tr>
                        </thead>
                        <tbody id="monitoring-list-tbody">
                            </tbody>
                    </table>
                </div>
            </div>

            <!-- Page: Token Usage Analysis (List View) -->
            <div id="tokens" class="page active">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">í† í° ì‚¬ìš©ëŸ‰ ìƒì„¸ ë¶„ì„</h2>
                    <a href="#" target="_blank" class="bg-gray-800 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-900">LangSmithì—ì„œ ë³´ê¸° â†—</a>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card text-center">
                        <p class="text-gray-500 text-sm">ì´ ì‚¬ìš© ë¹„ìš© (ì´ë²ˆ ë‹¬)</p>
                        <p class="text-3xl font-bold mt-2">$182.50</p>
                    </div>
                    <div class="card text-center">
                        <p class="text-gray-500 text-sm">ì´ í† ë¡  ìˆ˜</p>
                        <p class="text-3xl font-bold mt-2">482</p>
                    </div>
                    <div class="card text-center">
                        <p class="text-gray-500 text-sm">í† ë¡  ë‹¹ í‰ê·  ë¹„ìš©</p>
                        <p class="text-3xl font-bold mt-2">$0.378</p>
                    </div>
                </div>

                <div class="card mb-8">
                    <h3 class="font-bold mb-4">í† ë¡ ë³„ ë¹„ìš© ë¶„ì„</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full table">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th>í† ë¡  ID</th>
                                    <th>ì‚¬ìš©ì</th>
                                    <th>ì´ í† í°</th>
                                    <th>ì˜ˆìƒ ë¹„ìš©</th>
                                    <th>ëª¨ë¸ë³„ ì‚¬ìš©ëŸ‰</th>
                                    <th>ìƒì„¸</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>sess_abc123</td>
                                    <td>user1@...</td>
                                    <td>15,820</td>
                                    <td>$0.45</td>
                                    <td>
                                        <div class="text-xs">
                                            <p><strong>GPT-4o:</strong> 8,120</p>
                                            <p><strong>Gemini:</strong> 5,200</p>
                                            <p><strong>Claude:</strong> 2,500</p>
                                        </div>
                                    </td>
                                    <td><a href="#" class="text-blue-500 font-semibold" onclick="showDetailPage('sess_abc123')">ë¶„ì„</a></td>
                                </tr>
                                 <tr>
                                    <td>sess_ghi789</td>
                                    <td>user3@...</td>
                                    <td>8,550</td>
                                    <td>$0.21</td>
                                    <td>
                                        <div class="text-xs">
                                            <p><strong>GPT-4o:</strong> 3,500</p>
                                            <p><strong>Gemini:</strong> 5,050</p>
                                        </div>
                                    </td>
                                    <td><a href="#" class="text-blue-500 font-semibold" onclick="showDetailPage('sess_ghi789')">ë¶„ì„</a></td>
                                </tr>
                                <tr>
                                    <td>sess_jkl012</td>
                                    <td>user1@...</td>
                                    <td>22,100</td>
                                    <td>$0.88</td>
                                    <td>
                                        <div class="text-xs">
                                            <p><strong>Claude:</strong> 22,100</p>
                                        </div>
                                    </td>
                                    <td><a href="#" class="text-blue-500 font-semibold" onclick="showDetailPage('sess_jkl012')">ë¶„ì„</a></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="font-bold mb-4">ëª¨ë¸ë³„ ì´ ë¹„ìš© ë¶„ì„</h3>
                        <div class="h-80"><canvas id="costByModelChart"></canvas></div>
                    </div>
                    <div class="card">
                        <h3 class="font-bold mb-4">ì¼ë³„ í† ë¡  ë¹„ìš© ì¶”ì´</h3>
                        <div class="h-80"><canvas id="dailyCostChart"></canvas></div>
                    </div>
                </div>
            </div>
            
            <!-- [NEW] Page: Token Usage Detail View -->
            <div id="token-detail" class="page">
                <div class="mb-6">
                    <button class="text-blue-600 font-semibold hover:underline" onclick="showPage('tokens')">â† í† í° ë¶„ì„ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
                <h2 class="text-3xl font-bold mb-2">í† ë¡  ìƒì„¸ ë¶„ì„: <span id="detail-session-id" class="text-blue-600"></span></h2>
                <p class="text-gray-500 mb-6" id="detail-topic"></p>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="card text-center"><p class="text-gray-500 text-sm">ì´ ë¹„ìš©</p><p id="detail-total-cost" class="text-3xl font-bold mt-2"></p></div>
                    <div class="card text-center"><p class="text-gray-500 text-sm">ì´ í† í°</p><p id="detail-total-tokens" class="text-3xl font-bold mt-2"></p></div>
                    <div class="card text-center"><p class="text-gray-500 text-sm">ì‚¬ìš©ì</p><p id="detail-user" class="text-xl font-bold mt-2"></p></div>
                    <div class="card text-center"><p class="text-gray-500 text-sm">í† ë¡  ì‹œê°„</p><p id="detail-duration" class="text-3xl font-bold mt-2"></p></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 card">
                        <h3 class="font-bold mb-4">ì—ì´ì „íŠ¸ë³„ ë¹„ìš© ìƒì„¸ ë‚´ì—­</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full table">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th>ìˆœì„œ</th>
                                        <th>ì—ì´ì „íŠ¸</th>
                                        <th>ëª¨ë¸</th>
                                        <th>ì…ë ¥ í† í°</th>
                                        <th>ì¶œë ¥ í† í°</th>
                                        <th>ë¹„ìš©</th>
                                    </tr>
                                </thead>
                                <tbody id="detail-turn-table">
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="font-bold mb-4">ì—ì´ì „íŠ¸ë³„ ë¹„ìš© ê¸°ì—¬ë„</h3>
                        <div class="h-80"><canvas id="costByAgentChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Page: Agent Settings -->
            <div id="agents" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">ì—ì´ì „íŠ¸ ì„¤ì •</h2>
                    <button class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700" onclick="openAgentAddModal()">ï¼‹ ìƒˆ ì—ì´ì „íŠ¸ ì¶”ê°€</button>
                </div>

                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex -mb-px space-x-8" aria-label="Tabs">
                        <a id="expert-agents-tab" class="tab-link active">
                            Expert Agents
                        </a>
                        <a id="special-agents-tab" class="tab-link">
                            Special Agents
                        </a>
                    </nav>
                </div>

                <div id="expert-agents-content" class="tab-content active">
                    <div class="mb-6 flex gap-2">
                        <input type="text" id="expert-agent-search-input" placeholder="ì—ì´ì „íŠ¸ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." class="w-full md:w-1/3 p-2 border-gray-300 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="expert-agent-search-button" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">ê²€ìƒ‰</button>
                    </div>
                    <div id="expert-agents-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        </div>
                </div>

                <div id="special-agents-content" class="tab-content">
                    <div id="special-agents-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    </div>
                </div>
            </div>

            <div id="discussion-detail" class="page">
                <div class="mb-6">
                    <button class="text-blue-600 font-semibold hover:underline" onclick="showPage('monitoring')">
                        â† í† ë¡  ì´ë ¥ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                </div>
                <div id="discussion-detail-content">
                    <div class="text-center p-8">
                        <p>ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ì‚¬ìš©ì ì¶”ê°€ -->
    <div id="user-add-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="card w-full max-w-lg max-h-[90vh] flex flex-col p-0">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold text-blue-600">ìƒˆ ê³„ì • ì¶”ê°€</h2>
                <button class="text-2xl font-bold" onclick="toggleModal('user-add-modal')">&times;</button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <div>
                    <label class="font-semibold">ì´ë¦„</label>
                    <input type="text" id="new-user-name" placeholder="í™ê¸¸ë™" class="w-full mt-1 p-2 border-gray-300 border rounded-lg">
                </div>
                <div>
                    <label class="font-semibold">ì´ë©”ì¼</label>
                    <input type="email" id="new-user-email" placeholder="user@example.com" class="w-full mt-1 p-2 border-gray-300 border rounded-lg">
                </div>
                <div>
                    <label class="font-semibold">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="new-user-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" class="w-full mt-1 p-2 border-gray-300 border rounded-lg">
                </div>
                <div>
                    <label class="font-semibold">ì—­í• </label>
                    <select id="new-user-role" class="w-full mt-1 p-2 border-gray-300 border rounded-lg bg-white">
                        <option value="user" selected>user</option>
                        <option value="admin">admin</option>
                    </select>
                </div>
                <div id="user-add-error" class="text-sm text-red-500 h-4"></div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end items-center gap-4">
                <button class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300" onclick="toggleModal('user-add-modal')">ì·¨ì†Œ</button>
                <button id="save-user-button" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- ì‚¬ìš©ì ìˆ˜ì • -->
    <div id="user-edit-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="card w-full max-w-lg max-h-[90vh] flex flex-col p-0">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold text-blue-600">ê³„ì • ì •ë³´ ìˆ˜ì •</h2>
                <button class="text-2xl font-bold" onclick="toggleModal('user-edit-modal')">&times;</button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="edit-user-id">
                <div>
                    <label class="font-semibold">ì´ë¦„</label>
                    <input type="text" id="edit-user-name" class="w-full mt-1 p-2 border-gray-300 border rounded-lg">
                </div>
                <div>
                    <label class="font-semibold">ì´ë©”ì¼ (ìˆ˜ì • ë¶ˆê°€)</label>
                    <input type="email" id="edit-user-email" class="w-full mt-1 p-2 border-gray-300 border rounded-lg bg-gray-100" readonly>
                </div>
                <div>
                    <label class="font-semibold">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="edit-user-password" placeholder="ë³€ê²½í•  ê²½ìš°ì—ë§Œ ì…ë ¥í•˜ì„¸ìš”" class="w-full mt-1 p-2 border-gray-300 border rounded-lg">
                </div>
                <div>
                    <label class="font-semibold">ì—­í• </label>
                    <select id="edit-user-role" class="w-full mt-1 p-2 border-gray-300 border rounded-lg bg-white">
                        <option value="user">user</option>
                        <option value="admin">admin</option>
                    </select>
                </div>
                <div id="user-edit-error" class="text-sm text-red-500 h-4"></div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end items-center gap-4">
                <button class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300" onclick="toggleModal('user-edit-modal')">ì·¨ì†Œ</button>
                <button id="save-edit-user-button" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">ìˆ˜ì •ì‚¬í•­ ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="agent-form-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="card w-full max-w-2xl max-h-[90vh] flex flex-col p-0">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 id="agent-modal-title" class="text-xl font-bold text-blue-600">ì—ì´ì „íŠ¸ ì„¤ì •</h2>
                <button class="text-2xl font-bold" onclick="toggleModal('agent-form-modal')">&times;</button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="agent-form-mode" value="add">
                <div>
                    <label class="font-semibold">ì—ì´ì „íŠ¸ ì´ë¦„</label>
                    <input type="text" id="agent-form-name" placeholder="ì˜ˆ: ë°˜ë„ì²´ ì‚°ì—… ë¶„ì„ê°€" class="w-full mt-1 p-2 border-gray-300 border rounded-lg">
                </div>
                <div>
                    <label class="font-semibold">ì•„ì´ì½˜ (Emoji)</label>
                    <input type="text" id="agent-form-icon" placeholder="ì˜ˆ: ğŸ­" class="w-full mt-1 p-2 border-gray-300 border rounded-lg">
                </div>
                <div>
                    <label class="font-semibold">ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸</label>
                    <textarea id="agent-form-prompt" rows="8" class="w-full mt-1 p-2 border-gray-300 border rounded-lg" placeholder="ì—ì´ì „íŠ¸ì˜ ì—­í• ê³¼ ì§€ì‹œì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>
                <div>
                    <label class="font-semibold">LLM ëª¨ë¸</label>
                    <select id="agent-form-model" class="w-full mt-1 p-2 border-gray-300 border rounded-lg bg-white">
                    </select>
                </div>
                <div id="agent-form-error" class="text-sm text-red-500 h-4"></div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
                <button id="agent-delete-button" class="text-red-600 font-semibold hover:text-red-800 hidden">ì‚­ì œ</button>
                <div class="flex gap-4">
                    <button class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300" onclick="toggleModal('agent-form-modal')">ì·¨ì†Œ</button>
                    <button id="agent-save-button" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- [NEW] í”„ë¡¬í”„íŠ¸ ë³€ê²½ ì´ë ¥ Modal -->
    <div id="history-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="card w-full max-w-lg max-h-[70vh] flex flex-col p-0">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold text-blue-600">í”„ë¡¬í”„íŠ¸ ë³€ê²½ ì´ë ¥</h2>
                <button class="text-2xl font-bold" onclick="toggleModal('history-modal')">&times;</button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <div class="border-b pb-2">
                    <p class="font-semibold">ë²„ì „ 1.2 <span class="text-sm text-gray-500 font-normal">(2025-08-20 by admin)</span></p>
                    <p class="text-sm text-gray-600 mt-1">"You are a professional Financial Analyst. Your role is to provide insightful financial analysis..."</p>
                </div>
                 <div class="border-b pb-2">
                    <p class="font-semibold">ë²„ì „ 1.1 <span class="text-sm text-gray-500 font-normal">(2025-08-15 by admin)</span></p>
                    <p class="text-sm text-gray-600 mt-1">"You are a Financial Analyst..."</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        
        const SUPPORTED_MODELS = {
            "Google (Gemini)": [
                { id: "gemini-2.5-pro", name: "Gemini 2.5 pro" },
                { id: "gemini-2.5-flash", name: "Gemini 2.5 flash" },
                { id: "gemini-2.5-flash-lite", name: "Gemini 2.5 flash lite" },
                { id: "gemini-2.0-flash", name: "Gemini 2.0 flash" },
                { id: "gemini-1.5-pro", name: "Gemini 1.5 Pro" },
                { id: "gemini-1.5-flash", name: "Gemini 1.5 Flash" }
            ],
            "OpenAI (GPT)": [
                { id: "gpt-4o", name: "GPT-4o" },
                { id: "gpt-4o-mini", name: "GPT-4o mini" },
                { id: "gpt-4-turbo", name: "GPT-4 Turbo" },
                { id: "gpt-4", name: "GPT-4" },
                { id: "gpt-3.5-turbo", name: "GPT-3.5 Turbo" }
            ],
            "Anthropic (Claude)": [
                { id: "claude-opus-4-1-20250805", name: "Claude 4.1 opus" },
                { id: "claude-opus-4-20250514", name: "Claude 4 Sonnet" },
                { id: "claude-3-5-haiku-20241022", name: "Claude 3.5 Haiku" },
                { id: "claude-3-7-sonnet-20250219", name: "Claude 3.7 Sonnet" },
                { id: "claude-3-5-sonnet-20241022", name: "Claude 3.5 Sonnet" },
                { id: "claude-3-haiku-20240307", name: "Claude 3 Haiku" }
            ]
        };

        let allAgentsData = {};
        // ì „ì—­ ë³€ìˆ˜ë¡œ ì‚¬ìš©ì ëª©ë¡ ë°ì´í„° ì €ì¥
        let currentUsers = [];

        // Mock Data for Detail Page
        const detailData = {
            "sess_abc123": {
                topic: "í…ŒìŠ¬ë¼ ì£¼ê°€ ì „ë§ì— ëŒ€í•œ ì‹¬ì¸µ ë¶„ì„",
                total_cost: 0.45,
                total_tokens: 15820,
                user: "user1@example.com",
                duration: "12ë¶„ 30ì´ˆ",
                turns: [
                    { turn: 1, agent: "SNS íŠ¸ë Œë“œ ë¶„ì„ê°€", model: "Gemini 1.5", input: 500, output: 1200, cost: 0.05 },
                    { turn: 2, agent: "ì¬ë¬´ ë¶„ì„ê°€", model: "GPT-4o", input: 1500, output: 800, cost: 0.10 },
                    { turn: 3, agent: "ë¹„íŒì  ê´€ì ", model: "Claude 3.5", input: 1300, output: 1200, cost: 0.08 },
                    { turn: 4, agent: "ê±°ì‹œê²½ì œ ì „ë¬¸ê°€", model: "Gemini 1.5", input: 1800, output: 1700, cost: 0.12 },
                    { turn: 5, agent: "ì¬ë¬´ ë¶„ì„ê°€", model: "GPT-4o", input: 2120, output: 1500, cost: 0.10 },
                ]
            }
        };

        function showPage(pageId) {
            // ëª¨ë“  '.page' divë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            
            // ìš”ì²­ëœ IDì˜ divê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ ë³´ì—¬ì¤ë‹ˆë‹¤.
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            } else {
                console.error(`[ì˜¤ë¥˜] showPage: '${pageId}' IDë¥¼ ê°€ì§„ í˜ì´ì§€ divë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return; // í˜ì´ì§€ê°€ ì—†ìœ¼ë©´ í•¨ìˆ˜ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.
            }

            // ëª¨ë“  ì‚¬ì´ë“œë°” ë§í¬ì˜ í™œì„± ìƒíƒœë¥¼ ì œê±°í•©ë‹ˆë‹¤.
            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));

            // í™œì„±í™”í•  ë§í¬ IDë¥¼ ê²°ì •í•©ë‹ˆë‹¤ (ìƒì„¸ í˜ì´ì§€ëŠ” ëª¨ë‹ˆí„°ë§ ë©”ë‰´ë¥¼ í™œì„±í™”).
            let linkToActivateId = pageId;
            if (pageId === 'discussion-detail') {
                linkToActivateId = 'monitoring';
            }

            const activeLink = document.querySelector(`.sidebar-link[onclick="showPage('${linkToActivateId}')"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            // í˜ì´ì§€ë³„ ë°ì´í„° ë¡œë”©
            if (pageId === 'users') {
                loadUsers();
            }
            if (pageId === 'monitoring') {
                loadDiscussions();
            }
            if (pageId === 'agents') {
                loadAgents();
            }
        }

        function toggleModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
            } else {
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        let costByAgentChartInstance;
        function showDetailPage(sessionId) {
            const data = detailData[sessionId] || detailData["sess_abc123"]; // Fallback for demo

            // Populate summary
            document.getElementById('detail-session-id').textContent = sessionId;
            document.getElementById('detail-topic').textContent = `ì£¼ì œ: ${data.topic}`;
            document.getElementById('detail-total-cost').textContent = `$${data.total_cost.toFixed(2)}`;
            document.getElementById('detail-total-tokens').textContent = data.total_tokens.toLocaleString();
            document.getElementById('detail-user').textContent = data.user;
            document.getElementById('detail-duration').textContent = data.duration;

            // Populate turn-by-turn table
            const tableBody = document.getElementById('detail-turn-table');
            tableBody.innerHTML = '';
            data.turns.forEach(turn => {
                const row = `
                    <tr>
                        <td>${turn.turn}</td>
                        <td>${turn.agent}</td>
                        <td><span class="bg-gray-100 text-gray-800 text-xs font-medium px-2 py-0.5 rounded">${turn.model}</span></td>
                        <td>${turn.input.toLocaleString()}</td>
                        <td>${turn.output.toLocaleString()}</td>
                        <td>$${turn.cost.toFixed(3)}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Aggregate data for chart
            const agentCosts = data.turns.reduce((acc, turn) => {
                acc[turn.agent] = (acc[turn.agent] || 0) + turn.cost;
                return acc;
            }, {});

            const chartLabels = Object.keys(agentCosts);
            const chartData = Object.values(agentCosts);

            // Create or update agent cost chart
            const ctxCostAgent = document.getElementById('costByAgentChart').getContext('2d');
            if (costByAgentChartInstance) {
                costByAgentChartInstance.destroy();
            }
            costByAgentChartInstance = new Chart(ctxCostAgent, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'ë¹„ìš© ê¸°ì—¬ë„ ($)',
                        data: chartData,
                        backgroundColor: ['#2563eb', '#34d399', '#f59e0b', '#ef4444', '#8b5cf6']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            showPage('token-detail');
        }

        /**
         * APIì—ì„œ ì‚¬ìš©ì ëª©ë¡ì„ ê°€ì ¸ì™€ í…Œì´ë¸”ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
         */
        async function loadUsers() {
            const token = localStorage.getItem('accessToken');
            if (!token) return;

            const tbody = document.getElementById('user-list-tbody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';

            try {
                const response = await fetch('/api/v1/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`[${response.status}] ì‚¬ìš©ì ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
                }

                const users = await response.json();
                tbody.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì‚­ì œ

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">í‘œì‹œí•  ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                // ì„œë²„ì—ì„œ ì´ë¯¸ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬í•´ì„œ ë³´ë‚´ì£¼ë¯€ë¡œ ë°”ë¡œ ì‚¬ìš©
                users.forEach((user, index) => {
                    const row = document.createElement('tr');
                    // ëª¨ë“  user.idë¥¼ user._idë¡œ ì°¸ì¡°
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${formatDateTime(user.created_at)}</td>
                        <td>${formatDateTime(user.last_login_at)}</td>
                        <td>
                            <button class="text-blue-500 text-sm font-semibold edit-btn" data-userid="${user._id}">ìˆ˜ì •</button> 
                            <button class="text-red-500 text-sm font-semibold ml-2 delete-btn" data-userid="${user._id}" data-username="${user.name}">ì‚­ì œ</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                window.currentUsers = users;

            } catch (error) {
                console.error('Error loading users:', error);
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-red-500 py-4">${error.message}</td></tr>`;
            }
        }

        /**
         * 'ì €ì¥' ë²„íŠ¼ í´ë¦­ ì‹œ ìƒˆ ì‚¬ìš©ì ì •ë³´ë¥¼ ì„œë²„ì— POST ìš”ì²­í•˜ëŠ” í•¨ìˆ˜
         */
        async function handleAddNewUser() {
            const nameInput = document.getElementById('new-user-name');
            const emailInput = document.getElementById('new-user-email');
            const passwordInput = document.getElementById('new-user-password');
            const roleInput = document.getElementById('new-user-role');
            const errorDiv = document.getElementById('user-add-error');
            const saveButton = document.getElementById('save-user-button');

            const newUser = {
                name: nameInput.value.trim(),
                email: emailInput.value.trim(),
                password: passwordInput.value,
                role: roleInput.value
            };

            // ê°„ë‹¨í•œ ìœ íš¨ì„± ê²€ì‚¬
            if (!newUser.name || !newUser.email || !newUser.password) {
                errorDiv.textContent = 'ì´ë¦„, ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.';
                return;
            }
            errorDiv.textContent = '';
            saveButton.disabled = true;
            saveButton.textContent = 'ì €ì¥ ì¤‘...';

            const token = localStorage.getItem('accessToken');

            try {
                const response = await fetch('/api/v1/users/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newUser)
                });

                if (response.status === 201) { // 201 Created
                    alert('ìƒˆë¡œìš´ ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    toggleModal('user-add-modal');
                    await loadUsers(); // ì‚¬ìš©ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    const errorData = await response.json();
                    errorDiv.textContent = errorData.detail || 'ì‚¬ìš©ì ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                }
            } catch (error) {
                console.error('Error adding new user:', error);
                errorDiv.textContent = 'ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'ì €ì¥';
            }
        }

        /**
         * ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ì„ ì—´ê³  ê¸°ì¡´ ì •ë³´ë¥¼ ì±„ìš°ëŠ” í•¨ìˆ˜
         */
        function openEditModal(userId) {
            const user = window.currentUsers.find(u => u._id === userId);
            if (!user) {
                alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            document.getElementById('edit-user-id').value = user._id;
            document.getElementById('edit-user-name').value = user.name;
            document.getElementById('edit-user-email').value = user.email;
            document.getElementById('edit-user-role').value = user.role;
            document.getElementById('edit-user-password').value = '';
            document.getElementById('user-edit-error').textContent = '';

            toggleModal('user-edit-modal');
        }

        /**
         * ìˆ˜ì •ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ì„œë²„ì— PUT ìš”ì²­í•˜ëŠ” í•¨ìˆ˜
         */
        async function handleUpdateUser() {
            const userId = document.getElementById('edit-user-id').value;
            const name = document.getElementById('edit-user-name').value.trim();
            const password = document.getElementById('edit-user-password').value;
            const role = document.getElementById('edit-user-role').value;
            const errorDiv = document.getElementById('user-edit-error');
            const saveButton = document.getElementById('save-edit-user-button');

            const updatePayload = { name, role };
            // ë¹„ë°€ë²ˆí˜¸ í•„ë“œê°€ ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°ì—ë§Œ payloadì— ì¶”ê°€
            if (password) {
                updatePayload.password = password;
            }

            saveButton.disabled = true;
            saveButton.textContent = 'ì €ì¥ ì¤‘...';
            errorDiv.textContent = '';
            const token = localStorage.getItem('accessToken');

            try {
                const response = await fetch(`/api/v1/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatePayload)
                });

                if (response.ok) {
                    alert('ì‚¬ìš©ì ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    toggleModal('user-edit-modal');
                    await loadUsers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    const errorData = await response.json();
                    errorDiv.textContent = errorData.detail || 'ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                }
            } catch (error) {
                errorDiv.textContent = 'ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'ìˆ˜ì •ì‚¬í•­ ì €ì¥';
            }
        }

        /**
         * ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ í™•ì¸ í›„ ì„œë²„ì— DELETE ìš”ì²­í•˜ëŠ” í•¨ìˆ˜
         */
        async function handleDeleteUser(userId, userName) {
            if (!confirm(`ì •ë§ë¡œ '${userName}' ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }
            
            const token = localStorage.getItem('accessToken');

            try {
                const response = await fetch(`/api/v1/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert(`'${userName}' ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    await loadUsers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    const errorData = await response.json();
                    alert(`ì‚­ì œ ì‹¤íŒ¨: ${errorData.detail}`);
                }
            } catch (error) {
                alert('ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        /**
         * ë‚ ì§œ ë¬¸ìì—´ì„ 'YYYY-MM-DD HH:MM:SS' í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
         * @param {string | null} dateString - ë³€í™˜í•  ë‚ ì§œ ë¬¸ìì—´
         * @returns {string} - í¬ë§·ëœ ë‚ ì§œ ë˜ëŠ” 'N/A'
        
         * ë‚ ì§œ ë¬¸ìì—´ì„ í•œêµ­ ì‹œê°„(KST)ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
         * ì„œë²„ì—ì„œ ë°›ì€ UTC ì‹œê°„ ê°ì²´ì— ì§ì ‘ 9ì‹œê°„ì„ ë”í•´ KSTë¡œ ë§Œë“­ë‹ˆë‹¤.
         * @param {string | null} dateString - ë³€í™˜í•  ë‚ ì§œ ë¬¸ìì—´ (ì˜ˆ: '2025-09-18T05:54:57.765+00:00')
         * @returns {string} - 'YYYY-MM-DD HH:MM:SS' í˜•ì‹ì˜ KST ë‚ ì§œ
         */
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            try {
                // 1. ì„œë²„ì—ì„œ ë°›ì€ ì‹œê°„ ë¬¸ìì—´ë¡œ Date ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
                //    ì´ ê°ì²´ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ UTC ì‹œê°„ ì •ë³´ë¥¼ ê°€ì§‘ë‹ˆë‹¤.
                const date = new Date(dateString);

                if (isNaN(date.getTime())) return 'Invalid Date';

                // 2. [í•µì‹¬] UTC ì‹œê°„ì— 9ì‹œê°„ì„ ì§ì ‘ ë”í•˜ì—¬ í•œêµ­ ì‹œê°„(KST)ìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤.
                date.setHours(date.getHours() + 9);

                // 3. 9ì‹œê°„ì´ ë”í•´ì§„ ì‹œê°„ì„ ì›í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ì¡°í•©í•©ë‹ˆë‹¤.
                //    getUTCFullYear(), getUTCMonth() ë“±ì„ ì‚¬ìš©í•˜ì—¬ UTC ê¸°ì¤€ì˜ ë‚ ì§œ/ì‹œê°„ì„ ì¶”ì¶œí•´ì•¼
                //    ë¸Œë¼ìš°ì €ì˜ ìì²´ì ì¸ ì‹œê°„ëŒ€ ë³€í™˜ì„ ë§‰ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                const year = date.getUTCFullYear();
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const day = String(date.getUTCDate()).padStart(2, '0');
                const hours = String(date.getUTCHours()).padStart(2, '0');
                const minutes = String(date.getUTCMinutes()).padStart(2, '0');
                const seconds = String(date.getUTCSeconds()).padStart(2, '0');

                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            } catch (e) {
                return dateString; // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            
            showPage('agents'); // Default page

            const searchButton = document.getElementById('expert-agent-search-button');
            const searchInput = document.getElementById('expert-agent-search-input');

            searchButton.addEventListener('click', () => {
                loadExpertAgents(searchInput.value.trim());
            });

            searchInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    loadExpertAgents(searchInput.value.trim());
                }
            });

            document.getElementById('agent-save-button').addEventListener('click', handleSaveAgent);

            // ì—ì´ì „íŠ¸ ì €ì¥ ë° ì‚­ì œ ë²„íŠ¼ì— ëŒ€í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.getElementById('agent-save-button').addEventListener('click', handleSaveAgent);
            document.getElementById('agent-delete-button').addEventListener('click', () => {
                const agentName = document.getElementById('agent-form-name').value;
                handleDeleteAgent(agentName);
            });

            // íƒ­ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.getElementById('expert-agents-tab').addEventListener('click', (e) => {
                e.preventDefault();
                switchAgentTab('expert-agents');
            });
            document.getElementById('special-agents-tab').addEventListener('click', (e) => {
                e.preventDefault();
                switchAgentTab('special-agents');
            });

            // Chart instances
            let weeklyChart, costModelChart, dailyCostChart;

            // Weekly Discussions Chart
            const ctxWeekly = document.getElementById('weeklyDiscussionsChart')?.getContext('2d');
            if(ctxWeekly) {
                weeklyChart = new Chart(ctxWeekly, {
                    type: 'line',
                    data: {
                        labels: ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'],
                        datasets: [{
                            label: 'í† ë¡  ìˆ˜',
                            data: [12, 19, 25, 28, 32, 22, 18],
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            // Cost by Model Chart
            const ctxCostModel = document.getElementById('costByModelChart')?.getContext('2d');
            if(ctxCostModel) {
                costModelChart = new Chart(ctxCostModel, {
                    type: 'pie',
                    data: {
                        labels: ['GPT-4o', 'Gemini 1.5 Pro', 'Claude 3.5 Sonnet'],
                        datasets: [{
                            label: 'ë¹„ìš© ($)',
                            data: [95.40, 55.20, 31.90],
                            backgroundColor: ['#2563eb', '#34d399', '#f59e0b']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            // Daily Cost Chart
            const ctxDailyCost = document.getElementById('dailyCostChart')?.getContext('2d');
            if(ctxDailyCost) {
                dailyCostChart = new Chart(ctxDailyCost, {
                    type: 'bar',
                    data: {
                        labels: ['8/12', '8/13', '8/14', '8/15', '8/16', '8/17', '8/18'],
                        datasets: [{
                            label: 'ì¼ë³„ ë¹„ìš© ($)',
                            data: [15.2, 22.5, 28.1, 30.5, 35.8, 25.4, 25.0],
                            backgroundColor: '#60a5fa'
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                    }
                });
            }

            // í† ë¡  ëª¨ë‹ˆí„°ë§ ê²€ìƒ‰ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const searchBtn = document.getElementById('monitoring-search-btn');
            if (searchBtn) {
                searchBtn.addEventListener('click', loadDiscussions);
            }

            // ì´ë©”ì¼ í•„í„°ì—ì„œ Enter í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ ê²€ìƒ‰ ì‹¤í–‰
            const searchTermInput = document.getElementById('monitoring-search-term');
            if (searchTermInput) {
                searchTermInput.addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') {
                        loadDiscussions();
                    }
                });
            }
            
        });

        document.addEventListener('DOMContentLoaded', () => {
            
            const logoutButton = document.getElementById('admin-logout-button');
            const accessToken = localStorage.getItem('accessToken');

            // ìƒˆ ê³„ì • ì¶”ê°€ ê¸°ëŠ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const addUserButton = document.getElementById('add-user-button');
            const saveUserButton = document.getElementById('save-user-button');

            if (addUserButton) {
                addUserButton.addEventListener('click', () => {
                    // ëª¨ë‹¬ì„ ì—´ê¸° ì „, ì…ë ¥ í•„ë“œì™€ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ê¹¨ë—í•˜ê²Œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
                    document.getElementById('new-user-name').value = '';
                    document.getElementById('new-user-email').value = '';
                    document.getElementById('new-user-password').value = '';
                    document.getElementById('new-user-role').value = 'user';
                    document.getElementById('user-add-error').textContent = '';
                    toggleModal('user-add-modal');
                });
            }

            if (saveUserButton) {
                saveUserButton.addEventListener('click', handleAddNewUser);
            }

            // --- ì‚¬ìš©ì ëª©ë¡ì˜ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ì´ë²¤íŠ¸ ìœ„ì„) ---
            const userListBody = document.getElementById('user-list-tbody');
            if (userListBody) {
                userListBody.addEventListener('click', (event) => {
                    const target = event.target;
                    if (target.classList.contains('edit-btn')) {
                        const userId = target.dataset.userid;
                        openEditModal(userId);
                    }
                    if (target.classList.contains('delete-btn')) {
                        const userId = target.dataset.userid;
                        const userName = target.dataset.username;
                        handleDeleteUser(userId, userName);
                    }
                });
            }

            // --- [ì¶”ê°€] ìˆ˜ì • ëª¨ë‹¬ì˜ ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
            const saveEditButton = document.getElementById('save-edit-user-button');
            if (saveEditButton) {
                saveEditButton.addEventListener('click', handleUpdateUser);
            }

            // 1. í˜ì´ì§€ ë¡œë“œ ì‹œ, í† í°ì´ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì¦‰ì‹œ ì´ë™
            if (!accessToken) {
                console.log('ì•¡ì„¸ìŠ¤ í† í°ì´ ì—†ì–´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                window.location.href = '/';
                return;
            }

            // 2. ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            if (logoutButton) {
                logoutButton.addEventListener('click', (event) => {
                    event.preventDefault(); // a íƒœê·¸ì˜ ê¸°ë³¸ ë™ì‘ ë°©ì§€

                    // 3. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ì •ë³´ ì‚­ì œ
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('userEmail');

                    console.log('ê´€ë¦¬ì ê³„ì •ì´ ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');

                    // 4. ë©”ì¸ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
                    window.location.href = '/';
                });
            }
        });

        /**
         * í† ë¡  ìƒíƒœì— ë”°ë¼ ì ì ˆí•œ ìŠ¤íƒ€ì¼ì˜ ë±ƒì§€ HTMLì„ ë°˜í™˜í•©ë‹ˆë‹¤.
         * @param {string} status - í† ë¡  ìƒíƒœ ë¬¸ìì—´
         * @returns {string} - ë±ƒì§€ HTML
         */
        function renderStatusBadge(status) {
            const statusMap = {
                'completed': { text: 'ì™„ë£Œ', class: 'bg-green-100 text-green-800' },
                'report_generating': { text: 'ë³´ê³ ì„œ ìƒì„±ì¤‘', class: 'bg-blue-100 text-blue-800' },
                'waiting_for_vote': { text: 'ì§„í–‰ì¤‘', class: 'bg-yellow-100 text-yellow-800' },
                'turn_inprogress': { text: 'ì§„í–‰ì¤‘', class: 'bg-yellow-100 text-yellow-800' },
                'failed': { text: 'ì‹¤íŒ¨', class: 'bg-red-100 text-red-800' },
                'orchestrating': { text: 'íŒ€ êµ¬ì„±ì¤‘', class: 'bg-indigo-100 text-indigo-800' },
                'ready': { text: 'ì‹œì‘ ëŒ€ê¸°ì¤‘', class: 'bg-gray-100 text-gray-800' }
            };
            const statusInfo = statusMap[status] || { text: status, class: 'bg-gray-100 text-gray-800' };
            return `<span class="${statusInfo.class} text-xs font-medium px-2.5 py-0.5 rounded-full">${statusInfo.text}</span>`;
        }

        /**
         * APIì—ì„œ í† ë¡  ì´ë ¥ ëª©ë¡ì„ ê°€ì ¸ì™€ í…Œì´ë¸”ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
         */
        async function loadDiscussions() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                window.location.href = '/';
                return;
            }

            const tbody = document.getElementById('monitoring-list-tbody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">í† ë¡  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';

            // 1. ìƒˆë¡œìš´ UI ìš”ì†Œì—ì„œ ê°’ì„ ì½ì–´ì˜µë‹ˆë‹¤.
            const searchBy = document.getElementById('monitoring-search-by').value;
            const searchTerm = document.getElementById('monitoring-search-term').value.trim();
            
            let apiUrl = '/api/v1/admin/discussions';
            
            // 2. ê²€ìƒ‰ì–´ê°€ ìˆì„ ê²½ìš°ì—ë§Œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
            if (searchTerm) {
                apiUrl += `?search_by=${searchBy}&search_term=${encodeURIComponent(searchTerm)}`;
            }

            try {
                const response = await fetch(apiUrl, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // ... (ì´í•˜ ë¡œì§ì€ ë™ì¼)
                if (!response.ok) {
                    throw new Error(`[${response.status}] í† ë¡  ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
                }

                const discussions = await response.json();
                tbody.innerHTML = ''; 

                if (discussions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">í‘œì‹œí•  í† ë¡ ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                discussions.forEach(discussion => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="font-mono text-sm">${discussion.discussion_id}</td>
                        <td>${discussion.user_name}</td> <td>${discussion.user_email}</td>
                        <td class="max-w-xs truncate">${discussion.topic}</td>
                        <td>${formatDateTime(discussion.created_at)}</td>
                        <td>${renderStatusBadge(discussion.status)}</td>
                        <td><a href="#" class="text-blue-500 font-semibold" onclick="showDiscussionDetail('${discussion.discussion_id}')">ìƒì„¸ ë³´ê¸°</a></td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading discussions:', error);
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-red-500 py-4">${error.message}</td></tr>`;
            }
        }

        /**
         * íŠ¹ì • í† ë¡ ì˜ ìƒì„¸ ì •ë³´ë¥¼ APIë¡œ ìš”ì²­í•˜ê³  í™”ë©´ì— ë Œë”ë§í•˜ëŠ” ë©”ì¸ í•¨ìˆ˜
         * @param {string} discussionId - ìƒì„¸ ì¡°íšŒí•  í† ë¡ ì˜ ID
         */
        async function showDiscussionDetail(discussionId) {
            console.log(`[1] showDiscussionDetail í•¨ìˆ˜ ì‹œì‘ (ID: ${discussionId})`);
            showPage('discussion-detail');
            
            const detailContent = document.getElementById('discussion-detail-content');
            if (!detailContent) {
                console.error("[ì˜¤ë¥˜] 'discussion-detail-content' IDë¥¼ ê°€ì§„ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            detailContent.innerHTML = '<div class="text-center p-8"><p>ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';

            const token = localStorage.getItem('accessToken');
            if (!token) {
                detailContent.innerHTML = '<p class="text-red-500">ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>';
                return;
            }

            try {
                console.log('[2] API ì„œë²„ì— ìƒì„¸ ë°ì´í„° ìš”ì²­ ì‹œì‘...');
                const response = await fetch(`/api/v1/admin/discussions/${discussionId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`[${response.status}] ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
                }

                const data = await response.json();
                console.log('[3] APIë¡œë¶€í„° ë°ì´í„° ìˆ˜ì‹  ì„±ê³µ:', data);
                
                renderDiscussionDetail(data);

            } catch (error) {
                console.error('Error loading discussion detail:', error);
                detailContent.innerHTML = `<p class="text-center text-red-500 py-4">${error.message}</p>`;
            }
        }

        /**
         * ìƒì„¸ í† ë¡  ë°ì´í„°ë¥¼ ë°›ì•„ HTMLë¡œ ë³€í™˜í•˜ê³  í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
         * @param {object} data - APIë¡œë¶€í„° ë°›ì€ í† ë¡  ìƒì„¸ ì •ë³´
         */
        function renderDiscussionDetail(data) {
            console.log('[4] renderDiscussionDetail í•¨ìˆ˜ ì‹œì‘. ë°›ì€ ë°ì´í„°:', data);
            const detailContent = document.getElementById('discussion-detail-content');

            const summaryHtml = `
                <div class="card mb-6">
                    <h2 class="text-2xl font-bold mb-4">${data.topic || 'ì£¼ì œ ì—†ìŒ'}</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div><p class="text-gray-500">ì‚¬ìš©ìëª…</p><p class="font-semibold">${data.user_name || 'N/A'}</p></div>
                        <div><p class="text-gray-500">ì´ë©”ì¼</p><p class="font-semibold">${data.user_email || 'N/A'}</p></div>
                        <div><p class="text-gray-500">ì‹œì‘ ì‹œê°„</p><p class="font-semibold">${formatDateTime(data.created_at)}</p></div>
                        <div><p class="text-gray-500">ìƒíƒœ</p><div>${renderStatusBadge(data.status)}</div></div>
                    </div>
                </div>
            `;

            const participantMap = (data.participants || []).reduce((map, p) => {
                map[p.name] = p;
                return map;
            }, {});

            const transcriptHtml = (data.transcript || []).map(turn => {
                const agentName = turn.agent_name;
                if (["SNR ì „ë¬¸ê°€", "ì •ë³´ ê²€ì¦ë¶€", "êµ¬ë¶„ì„ "].includes(agentName)) return '';

                const icon = participantMap[agentName]?.icon || 'ğŸ¤–';
                const message = (turn.message || '').replace(/\n/g, '<br>');

                return `
                    <div class="flex items-start gap-3 my-4">
                        <div class="w-10 h-10 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center text-xl">${icon}</div>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-slate-800">${agentName}</p>
                            <div class="mt-1 p-3 rounded-lg inline-block bg-slate-100 text-left">${message}</div>
                        </div>
                    </div>
                `;
            }).join('');

            const finalHtml = `
                ${summaryHtml}
                <div class="card">
                    <h3 class="text-xl font-bold mb-4">ëŒ€í™” ì „ë¬¸</h3>
                    <div class="h-[60vh] overflow-y-auto pr-4">${transcriptHtml || '<p>ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}</div>
                </div>
            `;
            
            console.log('[5] ìµœì¢… HTML ìƒì„± ì™„ë£Œ. í™”ë©´ì— ë Œë”ë§í•©ë‹ˆë‹¤.');
            detailContent.innerHTML = finalHtml;
        }

        // --- Agent Settings Functions ---
        
        /**
         * ì—ì´ì „íŠ¸ íƒ­ì„ í´ë¦­í–ˆì„ ë•Œ UIë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
         */
        function switchAgentTab(targetTabId) {
            document.querySelectorAll('.tab-link').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.getElementById(`${targetTabId}-tab`).classList.add('active');
            document.getElementById(`${targetTabId}-content`).classList.add('active');
        }

        // Expert ì—ì´ì „íŠ¸ ë¡œë”©/ê²€ìƒ‰ì„ ìœ„í•œ ë³„ë„ í•¨ìˆ˜
        async function loadExpertAgents(searchTerm = '') {
            const token = localStorage.getItem('accessToken');
            if (!token) return;

            const grid = document.getElementById('expert-agents-grid');
            grid.innerHTML = '<p class="text-slate-500 col-span-full">Expert ì—ì´ì „íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
            
            let apiUrl = '/api/v1/admin/agents?agent_type=expert';
            if (searchTerm) {
                apiUrl += `&name_like=${encodeURIComponent(searchTerm)}`;
            }

            try {
                const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Expert ì—ì´ì „íŠ¸ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                const agents = await response.json();
                
                agents.forEach(agent => {
                    allAgentsData[agent._id] = agent;
                });

                renderAgentCards(agents, 'expert-agents-grid', 'expert');
            } catch (error) {
                console.error('Error loading expert agents:', error);
                grid.innerHTML = `<p class="text-red-500 col-span-full">${error.message}</p>`;
            }
        }
        
        // Special ì—ì´ì „íŠ¸ ë¡œë”©ì„ ìœ„í•œ ë³„ë„ í•¨ìˆ˜
        async function loadSpecialAgents() {
            const token = localStorage.getItem('accessToken');
            if (!token) return;
            const grid = document.getElementById('special-agents-grid');
            grid.innerHTML = '<p class="text-slate-500 col-span-full">Special ì—ì´ì „íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
            try {
                const response = await fetch('/api/v1/admin/agents?agent_type=special', { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Special ì—ì´ì „íŠ¸ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                const agents = await response.json();
                
                agents.forEach(agent => {
                    allAgentsData[agent._id] = agent;
                });
                
                renderAgentCards(agents, 'special-agents-grid', 'special');
            } catch (error) {
                console.error('Error loading special agents:', error);
                grid.innerHTML = `<p class="text-red-500 col-span-full">${error.message}</p>`;
            }
        }

        // ì´ˆê¸° ë¡œë”© í•¨ìˆ˜ëŠ” ê° íƒ€ì…ë³„ ë¡œë”© í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ë³€ê²½
        function loadAgents() {
            allAgentsData = {};
            loadExpertAgents();
            loadSpecialAgents();
        }

        /**
         * ì—ì´ì „íŠ¸ ë°ì´í„°ë¥¼ ë°›ì•„ ì¹´ë“œ UIë¥¼ ìƒì„±í•˜ê³  ì»¨í…Œì´ë„ˆì— ì‚½ì…í•˜ëŠ” í•¨ìˆ˜
         */
        function renderAgentCards(agents, containerId, agentType) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; 

            if (!agents || agents.length === 0) {
                container.innerHTML = '<p class="text-slate-500 col-span-full">í‘œì‹œí•  ì—ì´ì „íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            agents.forEach(agent => {
                const subtext = agentType === 'expert'
                    ? `<p class="text-xs text-gray-500 mt-1">ì°¸ì—¬ íšŸìˆ˜: <strong>${agent.discussion_participation_count || 0}</strong></p>`
                    : `<p class="text-xs text-gray-500 mt-1 capitalize">${agent.agent_type}</p>`;
                
                const cardHtml = `
                    <div class="card text-center relative transition-all hover:shadow-lg hover:-translate-y-1">
                        <div class="absolute top-4 right-4">
                            <button onclick="openAgentEditModal('${agent._id}')" class="text-xl text-gray-400 hover:text-gray-600">âš™ï¸</button>
                        </div>
                        <p class="text-5xl pt-4">${agent.config.icon || 'ğŸ¤–'}</p>
                        <h3 class="font-bold mt-2">${agent.name}</h3>
                        <p class="text-xs text-gray-400 mt-1">${agent.config.model}</p>
                        ${subtext}
                    </div>`;
                container.innerHTML += cardHtml;
            });
        }

        /**
         * ìƒˆ Expert ì—ì´ì „íŠ¸ ì¶”ê°€ ëª¨ë‹¬ì„ ì—¬ëŠ” í•¨ìˆ˜
         */
        function openAgentAddModal() {
            document.getElementById('agent-form-mode').value = 'add';
            document.getElementById('agent-modal-title').textContent = 'ìƒˆ Expert ì—ì´ì „íŠ¸ ì¶”ê°€';
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('agent-form-name').value = '';
            document.getElementById('agent-form-name').readOnly = false; // ì´ë¦„ í•„ë“œ í™œì„±í™”
            document.getElementById('agent-form-icon').value = 'ğŸ¤–';
            document.getElementById('agent-form-prompt').value = '';
            document.getElementById('agent-form-error').textContent = '';

            // ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            document.getElementById('agent-delete-button').classList.add('hidden');

            // LLM ëª¨ë¸ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
            const modelSelect = document.getElementById('agent-form-model');
            modelSelect.innerHTML = '';
            for (const provider in SUPPORTED_MODELS) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = provider;
                SUPPORTED_MODELS[provider].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name;
                    // ê¸°ë³¸ ì„ íƒê°’ ì„¤ì •
                    if (model.id === 'gemini-1.5-pro') {
                        option.selected = true;
                    }
                    optgroup.appendChild(option);
                });
                modelSelect.appendChild(optgroup);
            }
            
            toggleModal('agent-form-modal');
        }

        /**
         * ì—ì´ì „íŠ¸ ìˆ˜ì • ëª¨ë‹¬ì„ ì—¬ëŠ” í•¨ìˆ˜
         */
        function openAgentEditModal(agentId) {
            const agent = allAgentsData[agentId];
            if (!agent) {
                alert('ì—ì´ì „íŠ¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            document.getElementById('agent-form-mode').value = 'edit';
            document.getElementById('agent-modal-title').textContent = 'ì—ì´ì „íŠ¸ ìˆ˜ì •';

            const nameInput = document.getElementById('agent-form-name');
            nameInput.value = agent.name;
            nameInput.readOnly = true; // ì´ë¦„ì€ ê³ ìœ  ì‹ë³„ìì´ë¯€ë¡œ ìˆ˜ì • ë¶ˆê°€

            document.getElementById('agent-form-icon').value = agent.config.icon;
            document.getElementById('agent-form-prompt').value = agent.config.prompt;
            document.getElementById('agent-form-error').textContent = '';

            // ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
            const deleteButton = document.getElementById('agent-delete-button');
            deleteButton.classList.remove('hidden');
            // Special ì—ì´ì „íŠ¸ëŠ” ì‚­ì œ(ë¹„í™œì„±í™”)í•  ìˆ˜ ì—†ë„ë¡ ì²˜ë¦¬
            if (agent.agent_type === 'special') {
                deleteButton.disabled = true;
                deleteButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                deleteButton.disabled = false;
                deleteButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }


            // LLM ëª¨ë¸ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê³  í˜„ì¬ ëª¨ë¸ ì„ íƒ
            const modelSelect = document.getElementById('agent-form-model');
            modelSelect.innerHTML = '';
            for (const provider in SUPPORTED_MODELS) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = provider;
                SUPPORTED_MODELS[provider].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name;
                    if (model.id === agent.config.model) {
                        option.selected = true;
                    }
                    optgroup.appendChild(option);
                });
                modelSelect.appendChild(optgroup);
            }
            
            toggleModal('agent-form-modal');
        }

        /**
         * 'ì €ì¥' ë²„íŠ¼ í´ë¦­ ì‹œ ìƒˆ ì—ì´ì „íŠ¸ ì •ë³´ë¥¼ ì„œë²„ì— POST ìš”ì²­í•˜ëŠ” í•¨ìˆ˜
         */
        async function handleSaveAgent() {
            const mode = document.getElementById('agent-form-mode').value;
            const name = document.getElementById('agent-form-name').value.trim();
            const icon = document.getElementById('agent-form-icon').value.trim();
            const promptText = document.getElementById('agent-form-prompt').value.trim();
            const model = document.getElementById('agent-form-model').value;
            const errorDiv = document.getElementById('agent-form-error');
            const saveButton = document.getElementById('agent-save-button');

            if (!name || !promptText) {
                errorDiv.textContent = 'ì—ì´ì „íŠ¸ ì´ë¦„ê³¼ í”„ë¡¬í”„íŠ¸ëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.';
                return;
            }
            errorDiv.textContent = '';
            saveButton.disabled = true;
            saveButton.textContent = 'ì €ì¥ ì¤‘...';

            const configPayload = {
                prompt: promptText,
                model: model,
                icon: icon || 'ğŸ¤–',
                temperature: 0.3,
                tools: []
            };

            const token = localStorage.getItem('accessToken');
            let url, method;

            if (mode === 'add') {
                url = '/api/v1/admin/agents/';
                method = 'POST';
            } else { // edit mode
                url = `/api/v1/admin/agents/${encodeURIComponent(name)}`;
                method = 'PUT';
            }

            const bodyPayload = mode === 'add' ? { name: name, agent_type: "expert", config: configPayload } : configPayload;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bodyPayload)
                });

                if (response.ok) {
                    const actionText = mode === 'add' ? 'ì¶”ê°€' : 'ìˆ˜ì •';
                    alert(`ì—ì´ì „íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ${actionText}ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆ ë²„ì „ì´ ì´ˆì•ˆìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    toggleModal('agent-form-modal');
                    await loadAgents();
                } else {
                    const errorData = await response.json();
                    errorDiv.textContent = errorData.detail || 'ì—ì´ì „íŠ¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                }
            } catch (error) {
                console.error('Error saving agent:', error);
                errorDiv.textContent = 'ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'ì €ì¥';
            }
        }

        /**
         * ì—ì´ì „íŠ¸ ì‚­ì œ(ë¹„í™œì„±í™”)ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
         */
        async function handleDeleteAgent(agentName) {
            if (!confirm(`ì •ë§ë¡œ '${agentName}' ì—ì´ì „íŠ¸ë¥¼ ë¹„í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }

            const token = localStorage.getItem('accessToken');
            const saveButton = document.getElementById('agent-save-button'); // ë²„íŠ¼ ë¹„í™œì„±í™”ìš©
            const errorDiv = document.getElementById('agent-form-error');
            saveButton.disabled = true;
            errorDiv.textContent = 'ì‚­ì œ ì¤‘...';

            try {
                const response = await fetch(`/api/v1/admin/agents/${encodeURIComponent(agentName)}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert(`'${agentName}' ì—ì´ì „íŠ¸ê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    toggleModal('agent-form-modal');
                    await loadAgents();
                } else {
                    const errorData = await response.json();
                    errorDiv.textContent = `ì‚­ì œ ì‹¤íŒ¨: ${errorData.detail}`;
                }
            } catch (error) {
                errorDiv.textContent = 'ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            } finally {
                saveButton.disabled = false;
            }
        }

    </script>
</body>
</html>
